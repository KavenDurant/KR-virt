# KR-virt TOTP åŒå› å­è®¤è¯è®¾ç½®æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

KR-virt è™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿé›†æˆäº†åŸºäº RFC 6238 æ ‡å‡†çš„ TOTPï¼ˆTime-based One-Time Passwordï¼‰åŒå› å­è®¤è¯åŠŸèƒ½ï¼Œä¸ºç³»ç»Ÿæä¾›æ›´é«˜çº§åˆ«çš„å®‰å…¨ä¿æŠ¤ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **æ ‡å‡†å…¼å®¹**: åŸºäº RFC 6238 TOTP æ ‡å‡†å®ç°
- âœ… **å¤šåº”ç”¨æ”¯æŒ**: å…¼å®¹æ‰€æœ‰ä¸»æµè®¤è¯å™¨åº”ç”¨
- âœ… **é˜²é‡æ”¾æ”»å‡»**: é˜²æ­¢éªŒè¯ç é‡å¤ä½¿ç”¨
- âœ… **æ—¶é—´å®¹å·®**: æ”¯æŒ Â±30 ç§’æ—¶é—´åå·®
- âœ… **å®‰å…¨åŠ å¯†**: ä½¿ç”¨ HMAC-SHA1 åŠ å¯†ç®—æ³•
- âœ… **ç”¨æˆ·å‹å¥½**: ç®€åŒ–çš„è®¾ç½®æµç¨‹å’Œæ¸…æ™°çš„æŒ‡å¯¼

## ğŸ” æµ‹è¯•è´¦æˆ·é…ç½®

### é¦–æ¬¡ç™»å½•è´¦æˆ·ï¼ˆéœ€è¦è®¾ç½® TOTPï¼‰

| ç”¨æˆ·å   | åˆå§‹å¯†ç        | è§’è‰²          | æƒé™èŒƒå›´                         |
| -------- | -------------- | ------------- | -------------------------------- |
| test     | 123456         | administrator | å…¨éƒ¨ç³»ç»Ÿæƒé™                     |
| operator | Operator123!@# | operator      | vm:read, vm:create, network:read |
| auditor  | Auditor123!@#  | auditor       | audit:read, log:read             |

### å·²é…ç½®è´¦æˆ·ï¼ˆç›´æ¥ç™»å½•ï¼‰

| ç”¨æˆ·å | å¯†ç         | è§’è‰²          | TOTP çŠ¶æ€ |
| ------ | ----------- | ------------- | --------- |
| admin  | Admin123!@# | administrator | å·²é…ç½®    |

## ğŸš€ å®Œæ•´è®¾ç½®æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šç³»ç»Ÿè®¿é—®å’Œç™»å½•

1. **è®¿é—®ç³»ç»Ÿ**

   ```
   æµè§ˆå™¨æ‰“å¼€: http://localhost:3000/
   ```

2. **é¦–æ¬¡ç™»å½•**
   - ä½¿ç”¨æµ‹è¯•è´¦æˆ·ç™»å½•ï¼ˆæ¨èï¼štest/123456ï¼‰
   - ç³»ç»Ÿæ£€æµ‹åˆ°é¦–æ¬¡ç™»å½•çŠ¶æ€
   - è‡ªåŠ¨å¼¹å‡º"å®‰å…¨è®¾ç½®å‘å¯¼"

### ç¬¬äºŒæ­¥ï¼šå¯†ç å®‰å…¨å‡çº§

1. **å¯†ç ä¿®æ”¹å¯¹è¯æ¡†**
   - æ ‡é¢˜ï¼šğŸ”’ å®‰å…¨å‡çº§ - ä¿®æ”¹åˆå§‹å¯†ç 
   - è¾“å…¥æ–°å¯†ç ï¼ˆå»ºè®®ï¼š`KRvirt2025!@#`ï¼‰
   - ç¡®è®¤æ–°å¯†ç 
   - å®æ—¶æŸ¥çœ‹å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨

2. **å¯†ç è¦æ±‚**
   - æœ€å°‘ 8 ä¸ªå­—ç¬¦
   - åŒ…å«å¤§å†™å­—æ¯ (A-Z)
   - åŒ…å«å°å†™å­—æ¯ (a-z)
   - åŒ…å«æ•°å­— (0-9)
   - åŒ…å«ç‰¹æ®Šå­—ç¬¦ (!@#$%^&\*)
   - é¿å…å¸¸è§å¯†ç 

3. **å®Œæˆå¯†ç ä¿®æ”¹**
   - ç‚¹å‡»"ç¡®è®¤ä¿®æ”¹"
   - æ˜¾ç¤ºæˆåŠŸæç¤ºï¼š"å¯†ç ä¿®æ”¹æˆåŠŸï¼æ¥ä¸‹æ¥è®¾ç½®åŒå› å­è®¤è¯"
   - è‡ªåŠ¨è¿›å…¥ TOTP è®¾ç½®æµç¨‹

### ç¬¬ä¸‰æ­¥ï¼šTOTP åŒå› å­è®¤è¯è®¾ç½®

#### æ­¥éª¤ 1: æ‰«æé…ç½®äºŒç»´ç 

1. **ç•Œé¢å±•ç¤º**
   - æ­¥éª¤æŒ‡ç¤ºå™¨ï¼šğŸ” æ‰«æäºŒç»´ç  â†’ éªŒè¯è®¾ç½®
   - æ˜¾ç¤º QR ç å›¾ç‰‡ï¼ˆ200x200pxï¼‰
   - æ˜¾ç¤ºå¯†é’¥ï¼š`TA2SS5UUTTFSHBELVGVO53NRIR7AQHFM`
   - æä¾›è®¾ç½®æŒ‡å¯¼è¯´æ˜

2. **è®¤è¯å™¨åº”ç”¨é…ç½®**

   ```
   æ¨èè®¤è¯å™¨åº”ç”¨ï¼š
   â€¢ Google Authenticator (å…è´¹)
   â€¢ Microsoft Authenticator (å…è´¹)
   â€¢ Authy (å¤šè®¾å¤‡åŒæ­¥)
   â€¢ 1Password (ä»˜è´¹ï¼ŒåŠŸèƒ½ä¸°å¯Œ)
   â€¢ LastPass Authenticator (å…è´¹)
   ```

3. **é…ç½®æ–¹æ³•**
   - **è‡ªåŠ¨æ–¹å¼**: æ‰“å¼€è®¤è¯å™¨åº”ç”¨ â†’ æ‰«æ QR ç 
   - **æ‰‹åŠ¨æ–¹å¼**: é€‰æ‹©"æ‰‹åŠ¨è¾“å…¥" â†’ è¾“å…¥å¯†é’¥

4. **éªŒè¯é…ç½®**
   - è®¤è¯å™¨åº”ç”¨æ˜¾ç¤ºï¼šKRè™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿ (test)
   - æ¯ 30 ç§’ç”Ÿæˆæ–°çš„ 6 ä½éªŒè¯ç 
   - ç‚¹å‡»"ä¸‹ä¸€æ­¥"ç»§ç»­

#### æ­¥éª¤ 2: éªŒè¯ç éªŒè¯å’Œæ¿€æ´»

1. **éªŒè¯ç•Œé¢**
   - æ­¥éª¤æŒ‡ç¤ºå™¨ï¼šæ‰«æäºŒç»´ç  â†’ âœ… éªŒè¯è®¾ç½®
   - 6 ä½æ•°å­—è¾“å…¥æ¡†
   - å‰©ä½™æ—¶é—´å€’è®¡æ—¶æ˜¾ç¤º
   - éªŒè¯æŒ‰é’®å’Œé‡æ–°ç”Ÿæˆé€‰é¡¹

2. **éªŒè¯ç è·å–**
   - **ç”Ÿäº§æ–¹å¼**: ä»è®¤è¯å™¨åº”ç”¨è·å–å½“å‰ 6 ä½éªŒè¯ç 
   - **å¼€å‘è°ƒè¯•**: ç‚¹å‡»"ğŸ”§ è·å–æµ‹è¯•éªŒè¯ç "æŒ‰é’®

3. **å®ŒæˆéªŒè¯**
   - è¾“å…¥æ­£ç¡®çš„ 6 ä½éªŒè¯ç 
   - ç‚¹å‡»"éªŒè¯å¹¶å®Œæˆè®¾ç½®"
   - ç³»ç»ŸéªŒè¯æˆåŠŸæ˜¾ç¤ºï¼š"ğŸ‰ åŒå› å­è®¤è¯è®¾ç½®å®Œæˆï¼"

### ç¬¬å››æ­¥ï¼šè¿›å…¥ç³»ç»Ÿ

1. **è®¾ç½®å®Œæˆ**
   - æ˜¾ç¤º 3 ç§’æˆåŠŸæç¤º
   - è‡ªåŠ¨è·³è½¬åˆ°ç³»ç»Ÿä»ªè¡¨æ¿
   - ç”¨æˆ·çŠ¶æ€æ›´æ–°ï¼š`isFirstLogin: false`

2. **åç»­ç™»å½•**
   - ä½¿ç”¨æ–°å¯†ç ç™»å½•
   - æ¯æ¬¡ç™»å½•éœ€è¦è¾“å…¥ TOTP éªŒè¯ç 
   - éªŒè¯ç æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡

## ğŸ› ï¸ éªŒè¯ç è·å–æ–¹æ³•

### æ–¹æ³• 1: è®¤è¯å™¨åº”ç”¨ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

1. **ä¸‹è½½è®¤è¯å™¨åº”ç”¨**

   | åº”ç”¨åç§°                | å¹³å°                | ç‰¹ç‚¹                 | ä¸‹è½½é“¾æ¥                |
   | ----------------------- | ------------------- | -------------------- | ----------------------- |
   | Google Authenticator    | iOS/Android         | ç®€å•å¯é ï¼Œå®˜æ–¹æ”¯æŒ   | App Store / Google Play |
   | Microsoft Authenticator | iOS/Android         | äº‘å¤‡ä»½ï¼Œå¾®è½¯è´¦æˆ·é›†æˆ | App Store / Google Play |
   | Authy                   | iOS/Android/Desktop | å¤šè®¾å¤‡åŒæ­¥ï¼Œå¤‡ä»½æ¢å¤ | å®˜ç½‘ä¸‹è½½                |
   | 1Password               | å…¨å¹³å°              | å¯†ç ç®¡ç†å™¨é›†æˆ       | 1password.com           |

2. **é…ç½®æ­¥éª¤**

   ```
   1. æ‰“å¼€è®¤è¯å™¨åº”ç”¨
   2. ç‚¹å‡»"æ·»åŠ è´¦æˆ·"æˆ–"+"æŒ‰é’®
   3. é€‰æ‹©"æ‰«æäºŒç»´ç "
   4. æ‰«æé¡µé¢ä¸Šçš„ QR ç 
   5. è´¦æˆ·æ˜¾ç¤ºä¸ºï¼šKRè™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿ (ç”¨æˆ·å)
   6. æ¯ 30 ç§’è‡ªåŠ¨ç”Ÿæˆæ–°çš„ 6 ä½éªŒè¯ç 
   ```

3. **æ‰‹åŠ¨è¾“å…¥æ–¹å¼**
   ```
   è´¦æˆ·åç§°ï¼šKRè™šæ‹ŸåŒ–ç®¡ç†ç³»ç»Ÿ
   ç”¨æˆ·åï¼šä½ çš„ç™»å½•ç”¨æˆ·å
   å¯†é’¥ï¼šTA2SS5UUTTFSHBELVGVO53NRIR7AQHFM
   ç±»å‹ï¼šåŸºäºæ—¶é—´
   ç®—æ³•ï¼šSHA1
   ä½æ•°ï¼š6
   å‘¨æœŸï¼š30 ç§’
   ```

### æ–¹æ³• 2: å¼€å‘è°ƒè¯•ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰

1. **é¡µé¢è°ƒè¯•å·¥å…·**
   - åœ¨éªŒè¯ç è¾“å…¥é¡µé¢ç‚¹å‡»"ğŸ”§ è·å–æµ‹è¯•éªŒè¯ç "æŒ‰é’®
   - æ§åˆ¶å°æ˜¾ç¤ºå½“å‰å’Œä¸‹ä¸€ä¸ªéªŒè¯ç 
   - æ˜¾ç¤ºå‰©ä½™æœ‰æ•ˆæ—¶é—´
   - é¡µé¢å¼¹å‡ºå½“å‰éªŒè¯ç æç¤º

2. **æ§åˆ¶å°ä¿¡æ¯**
   ```javascript
   [TOTP Debug] å½“å‰éªŒè¯ç : 123456
   [TOTP Debug] ä¸‹ä¸€ä¸ªéªŒè¯ç : 789012
   [TOTP Debug] å‰©ä½™æ—¶é—´: 15 ç§’
   [TOTP Debug] æ—¶é—´çª—å£: å…è®¸ Â±30 ç§’åå·®
   ```

### æ–¹æ³• 3: åœ¨çº¿å·¥å…·ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰

1. **åœ¨çº¿ TOTP ç”Ÿæˆå™¨**

   ```
   æ¨èç½‘ç«™ï¼š
   â€¢ https://totp.danhersam.com/
   â€¢ https://stefansundin.github.io/2fa-qr/

   ä½¿ç”¨æ–¹æ³•ï¼š
   1. è®¿é—®å·¥å…·ç½‘ç«™
   2. è¾“å…¥å¯†é’¥ï¼šTA2SS5UUTTFSHBELVGVO53NRIR7AQHFM
   3. é€‰æ‹© SHA1, 6 ä½, 30 ç§’
   4. è·å–å½“å‰éªŒè¯ç 
   ```

2. **å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¼€å‘è€…ï¼‰**
   ```bash
   # é¡¹ç›®æ ¹ç›®å½•æä¾›çš„æµ‹è¯•å·¥å…·
   node totp-quick-test.js    # å¿«é€Ÿè·å–å½“å‰éªŒè¯ç 
   node totp-monitor.js       # å®æ—¶ç›‘æ§éªŒè¯ç å˜åŒ–
   ```

## âš™ï¸ æŠ€æœ¯å®ç°è¯¦è§£

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·ç•Œé¢å±‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç™»å½•é¡µé¢  â”‚  å¯†ç ä¿®æ”¹  â”‚  TOTPè®¾ç½®      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ä¸šåŠ¡é€»è¾‘å±‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¤è¯æœåŠ¡  â”‚  TOTPæœåŠ¡  â”‚  å®‰å…¨å·¥å…·      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              æ•°æ®å­˜å‚¨å±‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·çŠ¶æ€  â”‚  Tokenè®°å½• â”‚  å®‰å…¨æ—¥å¿—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

#### 1. TOTP æœåŠ¡ (`src/services/totpService.ts`)

```typescript
class TOTPService {
  // æ ¸å¿ƒåŠŸèƒ½
  generateCurrentToken(); // ç”Ÿæˆå½“å‰éªŒè¯ç 
  verifyToken(); // éªŒè¯è¾“å…¥çš„éªŒè¯ç 
  isValidSecret(); // éªŒè¯å¯†é’¥æ ¼å¼
  generateTOTPUrl(); // ç”ŸæˆäºŒç»´ç URL

  // å®‰å…¨ç‰¹æ€§
  é˜²é‡æ”¾æ”»å‡»ä¿æŠ¤; // è®°å½•å·²ä½¿ç”¨çš„éªŒè¯ç 
  æ—¶é—´çª—å£å®¹å·®; // Â±30ç§’æ—¶é—´åå·®
  è‡ªåŠ¨æ¸…ç†è¿‡æœŸè®°å½•; // å®šæœŸæ¸…ç†æ—§æ•°æ®
}
```

#### 2. è®¤è¯æœåŠ¡ (`src/services/authService.ts`)

```typescript
interface UserInfo {
  username: string;
  role: string;
  permissions: string[];
  isFirstLogin: boolean; // é¦–æ¬¡ç™»å½•æ ‡è¯†
  totpEnabled: boolean; // TOTPå¯ç”¨çŠ¶æ€
}
```

#### 3. å®‰å…¨å·¥å…· (`src/utils/security.ts`)

```typescript
class SecurityUtils {
  validatePassword(); // å¯†ç å¼ºåº¦éªŒè¯
  encryptData(); // æ•°æ®åŠ å¯†
  generateHash(); // å“ˆå¸Œç”Ÿæˆ
  sanitizeInput(); // è¾“å…¥æ¸…ç†
}
```

### çŠ¶æ€ç®¡ç†

#### React çŠ¶æ€è®¾è®¡

```typescript
interface LoginState {
  // ç™»å½•æµç¨‹æ§åˆ¶
  isLoading: boolean;
  currentStep: "login" | "changePassword" | "setupTOTP" | "complete";

  // å¯¹è¯æ¡†çŠ¶æ€
  showChangePasswordModal: boolean;
  showTOTPModal: boolean;
  totpStep: 0 | 1; // 0: æ‰«ç , 1: éªŒè¯

  // ç”¨æˆ·æ•°æ®
  currentUser: UserInfo | null;
  passwordStrength: PasswordValidation;

  // TOTP ç›¸å…³
  totpSecret: string;
  totpQRUrl: string;
  verificationCode: string;
}
```

#### æµç¨‹æ§åˆ¶é€»è¾‘

```typescript
const handleLoginSuccess = (user: UserInfo) => {
  if (user.isFirstLogin) {
    setCurrentStep("changePassword");
    setShowChangePasswordModal(true);
  } else {
    navigateToDashboard();
  }
};

const handlePasswordChanged = () => {
  setShowChangePasswordModal(false);
  setCurrentStep("setupTOTP");
  setupTOTPFlow();
};

const setupTOTPFlow = () => {
  const secret = "TA2SS5UUTTFSHBELVGVO53NRIR7AQHFM";
  const qrUrl = totpService.generateTOTPUrl(secret, username);
  setTotpSecret(secret);
  setTotpQRUrl(qrUrl);
  setShowTOTPModal(true);
  setTotpStep(0);
};
```

### å®‰å…¨æœºåˆ¶

#### 1. TOTP ç®—æ³•å®ç°

```
æ ‡å‡†ï¼šRFC 6238 (Time-Based One-Time Password)
ç®—æ³•ï¼šHMAC-SHA1
æ—¶é—´æ­¥é•¿ï¼š30 ç§’
éªŒè¯ç é•¿åº¦ï¼š6 ä½æ•°å­—
æ—¶é—´å®¹å·®ï¼šÂ±1 ä¸ªå‘¨æœŸï¼ˆæ€»å…± 90 ç§’æœ‰æ•ˆçª—å£ï¼‰
å¯†é’¥æ ¼å¼ï¼šBase32 ç¼–ç 
```

#### 2. é˜²é‡æ”¾æ”»å‡»

```typescript
private usedTokens = new Map<string, number>();

verifyToken(token: string) {
  const tokenKey = `${secret}-${token}`;
  const currentTime = Math.floor(Date.now() / 1000);

  // æ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨
  if (this.usedTokens.has(tokenKey)) {
    const usedTime = this.usedTokens.get(tokenKey)!;
    if (currentTime - usedTime < 300) { // 5åˆ†é’Ÿå†…
      return { success: false, message: "ä»¤ç‰Œå·²è¢«ä½¿ç”¨" };
    }
  }

  // éªŒè¯æˆåŠŸåè®°å½•
  this.usedTokens.set(tokenKey, currentTime);
}
```

#### 3. å¯†ç å®‰å…¨ç­–ç•¥

```typescript
interface PasswordRequirements {
  minLength: 8; // æœ€å°é•¿åº¦
  requireUppercase: true; // éœ€è¦å¤§å†™å­—æ¯
  requireLowercase: true; // éœ€è¦å°å†™å­—æ¯
  requireNumbers: true; // éœ€è¦æ•°å­—
  requireSpecialChars: true; // éœ€è¦ç‰¹æ®Šå­—ç¬¦
  blockCommonPasswords: true; // é˜»æ­¢å¸¸è§å¯†ç 
}
```

## ğŸ” æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### 1. ç™»å½•ç›¸å…³é—®é¢˜

| é—®é¢˜æè¿°           | å¯èƒ½åŸå›              | è§£å†³æ–¹æ¡ˆ                           |
| ------------------ | -------------------- | ---------------------------------- |
| æ— æ³•è®¿é—®ç™»å½•é¡µé¢   | å¼€å‘æœåŠ¡å™¨æœªå¯åŠ¨     | è¿è¡Œ `npm run dev` å¯åŠ¨æœåŠ¡å™¨      |
| è´¦æˆ·å¯†ç é”™è¯¯       | è¾“å…¥é”™è¯¯æˆ–è´¦æˆ·ä¸å­˜åœ¨ | æ£€æŸ¥æµ‹è¯•è´¦æˆ·åˆ—è¡¨ï¼Œç¡®è®¤ç”¨æˆ·åå’Œå¯†ç  |
| é¡µé¢ç©ºç™½æˆ–åŠ è½½å¤±è´¥ | å‰ç«¯æ„å»ºé”™è¯¯         | æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ï¼Œé‡æ–°æ„å»ºé¡¹ç›®       |

#### 2. å¯†ç ä¿®æ”¹é—®é¢˜

| é—®é¢˜æè¿°       | å¯èƒ½åŸå›          | è§£å†³æ–¹æ¡ˆ                       |
| -------------- | ---------------- | ------------------------------ |
| å¯†ç å¼ºåº¦ä¸å¤Ÿ   | ä¸ç¬¦åˆå®‰å…¨è¦æ±‚   | ç¡®ä¿åŒ…å«å¤§å°å†™ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ |
| ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´ | ç¡®è®¤å¯†ç è¾“å…¥é”™è¯¯ | é‡æ–°è¾“å…¥ç¡®è®¤å¯†ç                |
| ä¿®æ”¹æŒ‰é’®æ— å“åº” | è¡¨å•éªŒè¯å¤±è´¥     | æ£€æŸ¥æ‰€æœ‰å­—æ®µæ˜¯å¦æ­£ç¡®å¡«å†™       |

#### 3. TOTP è®¾ç½®é—®é¢˜

| é—®é¢˜æè¿°       | å¯èƒ½åŸå›              | è§£å†³æ–¹æ¡ˆ                           |
| -------------- | -------------------- | ---------------------------------- |
| äºŒç»´ç æ— æ³•æ˜¾ç¤º | å›¾ç‰‡æ–‡ä»¶ç¼ºå¤±         | ç¡®è®¤ `/public/QRCode.png` æ–‡ä»¶å­˜åœ¨ |
| æ— æ³•æ‰«æäºŒç»´ç  | è®¤è¯å™¨åº”ç”¨é—®é¢˜       | å°è¯•æ‰‹åŠ¨è¾“å…¥å¯†é’¥                   |
| éªŒè¯ç éªŒè¯å¤±è´¥ | æ—¶é—´ä¸åŒæ­¥æˆ–è¾“å…¥é”™è¯¯ | æ£€æŸ¥è®¾å¤‡æ—¶é—´ï¼Œç¡®è®¤éªŒè¯ç æ­£ç¡®       |
| éªŒè¯ç å·²è¿‡æœŸ   | éªŒè¯ç è¶…æ—¶           | ç­‰å¾…æ–°éªŒè¯ç ç”Ÿæˆï¼ˆæœ€å¤š30ç§’ï¼‰       |

#### 4. è®¤è¯å™¨åº”ç”¨é—®é¢˜

| é—®é¢˜æè¿°                      | è§£å†³æ–¹æ¡ˆ                           |
| ----------------------------- | ---------------------------------- |
| Google Authenticator æ— æ³•æ‰«ç  | ç¡®ä¿åº”ç”¨æœ‰ç›¸æœºæƒé™ï¼Œæˆ–ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥ |
| Authy åŒæ­¥é—®é¢˜                | æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œé‡æ–°ç™»å½• Authy è´¦æˆ·  |
| éªŒè¯ç ä¸åŒ¹é…                  | æ£€æŸ¥è®¾å¤‡æ—¶é—´æ˜¯å¦å‡†ç¡®ï¼Œå…è®¸30ç§’è¯¯å·® |
| å¤šä¸ªè®¾å¤‡éªŒè¯ç ä¸åŒ            | ç¡®ä¿æ‰€æœ‰è®¾å¤‡æ—¶é—´åŒæ­¥               |

### è°ƒè¯•å·¥å…·ä½¿ç”¨

#### 1. æµè§ˆå™¨å¼€å‘è€…å·¥å…·

```javascript
// æ‰“å¼€æ§åˆ¶å° (F12)ï¼ŒæŸ¥çœ‹ä»¥ä¸‹æ—¥å¿—ï¼š
[Login] ç”¨æˆ·ç™»å½•: test
[Password] å¯†ç å¼ºåº¦: strong
[TOTP] ç”ŸæˆéªŒè¯ç : 123456
[TOTP] éªŒè¯ç»“æœ: success
```

#### 2. ç½‘ç»œè¯·æ±‚è°ƒè¯•

```javascript
// åœ¨ Network æ ‡ç­¾é¡µæ£€æŸ¥ï¼š
POST / api / auth / login; // ç™»å½•è¯·æ±‚
PUT / api / auth / change - password; // å¯†ç ä¿®æ”¹
POST / api / auth / setup - totp; // TOTPè®¾ç½®
POST / api / auth / verify - totp; // TOTPéªŒè¯
```

#### 3. æœ¬åœ°å­˜å‚¨æ£€æŸ¥

```javascript
// åœ¨ Application æ ‡ç­¾é¡µæ£€æŸ¥ localStorageï¼š
kr_virt_token; // è®¤è¯ä»¤ç‰Œ
kr_virt_user; // ç”¨æˆ·ä¿¡æ¯
kr_virt_theme; // ä¸»é¢˜è®¾ç½®
```

### å¼€å‘ç¯å¢ƒç‰¹æ®ŠåŠŸèƒ½

#### 1. å¿«é€ŸéªŒè¯ç è·å–

```typescript
// åœ¨éªŒè¯ç é¡µé¢ï¼Œå¼€å‘ç¯å¢ƒæä¾›è°ƒè¯•æŒ‰é’®
onClick="getDebugTOTPCode()"

// æ§åˆ¶å°è¾“å‡ºï¼š
[TOTP Debug] å½“å‰éªŒè¯ç : 123456
[TOTP Debug] å‰©ä½™æ—¶é—´: 15ç§’
[TOTP Debug] ä¸‹ä¸€ä¸ªéªŒè¯ç : 789012
```

#### 2. è·³è¿‡ TOTP è®¾ç½®ï¼ˆå¼€å‘æ¨¡å¼ï¼‰

```typescript
// åœ¨å¼€å‘ç¯å¢ƒå¯ä»¥ä¸´æ—¶è·³è¿‡ TOTP
if (process.env.NODE_ENV === "development") {
  // æ˜¾ç¤º"è·³è¿‡è®¾ç½®"æŒ‰é’®
  setShowTOTPModal(false);
  navigate("/dashboard");
}
```

#### 3. æ¨¡æ‹Ÿä¸åŒç”¨æˆ·åœºæ™¯

```typescript
// ä¿®æ”¹ç”¨æˆ·æ•°æ®è¿›è¡Œæµ‹è¯•
const testScenarios = {
  firstLogin: { isFirstLogin: true, totpEnabled: false },
  normalUser: { isFirstLogin: false, totpEnabled: true },
  adminUser: { role: "administrator", permissions: ["*"] },
};
```

### æ€§èƒ½ç›‘æ§

#### 1. é¡µé¢åŠ è½½æ€§èƒ½

```javascript
// ä½¿ç”¨ Performance API ç›‘æ§
const perfData = performance.getEntriesByType("navigation")[0];
console.log("é¡µé¢åŠ è½½æ—¶é—´:", perfData.loadEventEnd - perfData.fetchStart, "ms");
```

#### 2. TOTP ç”Ÿæˆæ€§èƒ½

```javascript
// ç›‘æ§éªŒè¯ç ç”Ÿæˆæ—¶é—´
const startTime = performance.now();
const code = await totpService.generateCurrentToken(secret);
const endTime = performance.now();
console.log("TOTPç”Ÿæˆè€—æ—¶:", endTime - startTime, "ms");
```
