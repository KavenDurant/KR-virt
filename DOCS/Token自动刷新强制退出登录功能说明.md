# Token自动刷新强制退出登录功能说明

## 功能概述

当Token自动刷新失败时，系统会自动通知用户并强制退出登录，以确保账户安全。

## 触发条件

系统会在以下情况下强制退出登录：

### 1. Token刷新失败的情况
- 刷新结果中包含 "重新登录" 关键字
- 刷新结果中包含 "已失效" 关键字

### 2. 网络错误的情况
- HTTP 401 (未授权)
- HTTP 403 (禁止访问)

### 3. Token相关错误
- 错误消息中包含 "token"
- 错误消息中包含 "unauthorized"
- 错误消息中包含 "expired"

## 执行流程

当触发强制退出条件时，系统会按以下步骤执行：

1. **记录错误日志**
   ```
   🚨 认证失败，强制退出登录: [错误消息]
   ```

2. **停止Token自动刷新**
   - 清除刷新定时器
   - 防止后续的自动刷新尝试

3. **清除本地认证数据**
   - 删除存储的Token
   - 删除存储的用户信息

4. **显示用户通知**
   - 优先使用Ant Design的message组件
   - 降级使用浏览器原生alert

5. **重定向到登录页**
   - 延迟2秒后自动跳转
   - 仅在当前不在登录页时执行

## 通知消息类型

| 触发原因 | 显示消息 |
|---------|---------|
| Token刷新失败 | "Token自动刷新失败，为了您的账户安全，系统将自动退出登录" |
| 401/403错误 | "身份验证失败，系统将自动退出登录" |
| Token相关错误 | "Token验证失败，系统将自动退出登录" |

## 开发调试

在开发环境中，可以使用以下方式测试此功能：

```javascript
// 在浏览器控制台中
// 1. 模拟Token刷新失败
debugToken.refresh()

// 2. 查看当前状态
debugToken.status()

// 3. 清理Token(模拟失效)
debugToken.clear()
```

## 安全考虑

- **防止数据泄露**: 立即清除本地存储的敏感信息
- **用户体验**: 提供清晰的错误提示
- **自动处理**: 无需用户手动操作
- **容错机制**: 即使通知失败也会执行清理和跳转

## 兼容性

- **UI框架**: 自动检测Ant Design，降级到原生alert
- **路由**: 支持标准的window.location跳转
- **浏览器**: 支持所有现代浏览器

## 相关代码位置

- 主要逻辑: `src/services/login/index.ts` -> `TokenRefreshManager.handleAuthFailure()`
- 触发点1: `performRefresh()` 方法中的 `result.success` 检查
- 触发点2: `performRefresh()` 方法中的 `catch` 错误处理

## 注意事项

1. **非关键错误不会触发强制退出**
   - 5xx服务器错误(除非包含token关键字)
   - 网络超时(除非是认证相关)
   - 其他临时性错误

2. **重定向逻辑**
   - 只有在当前路径不是 `/login` 时才会重定向
   - 使用 `window.location.href` 进行硬跳转

3. **错误恢复**
   - 用户需要重新登录
   - 系统会重新启动Token自动刷新机制
