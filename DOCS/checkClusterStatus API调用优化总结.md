# checkClusterStatus APIè°ƒç”¨ä¼˜åŒ–æ€»ç»“

## ğŸ” é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜

åœ¨é›†ç¾¤åˆå§‹åŒ–æµç¨‹ä¸­ï¼Œ`checkClusterStatus` APIè¢«é‡å¤è°ƒç”¨äº†3-4æ¬¡ï¼Œå¯¼è‡´ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚ã€‚

### é—®é¢˜åŸå› åˆ†æ

1. **å¤šç»„ä»¶é‡å¤è°ƒç”¨**ï¼š
   - `AppBootstrap` ç»„ä»¶åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡
   - `ClusterInitPage` ç»„ä»¶åœ¨æŒ‚è½½æ—¶åˆè°ƒç”¨ä¸€æ¬¡

2. **React StrictMode**ï¼š
   - å¼€å‘æ¨¡å¼ä¸‹çš„ `<StrictMode>` ä¼šå¯¼è‡´ `useEffect` æ‰§è¡Œä¸¤æ¬¡
   - è¿™æ˜¯Reactçš„æ•…æ„è¡Œä¸ºï¼Œç”¨äºæ£€æµ‹å‰¯ä½œç”¨

3. **useCallbackä¾èµ–é—®é¢˜**ï¼š
   - useCallbackçš„ä¾èµ–å˜åŒ–å¯¼è‡´å‡½æ•°é‡æ–°åˆ›å»º
   - è¿›è€Œè§¦å‘useEffectçš„é‡æ–°æ‰§è¡Œ

4. **ç»„ä»¶é‡æ–°æ¸²æŸ“**ï¼š
   - è·¯ç”±å˜åŒ–æˆ–çŠ¶æ€æ›´æ–°å¯¼è‡´çš„ç»„ä»¶é‡æ¸²æŸ“

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. çŠ¶æ€ä¼ é€’ä¼˜åŒ–

**AppBootstrapç»„ä»¶æ”¹è¿›**ï¼š

```typescript
// ä¿å­˜é›†ç¾¤çŠ¶æ€å¹¶ä¼ é€’ç»™ClusterInitPage
const [clusterStatus, setClusterStatus] = useState<ClusterStatusResponse | null>(null);

// ä¼ é€’åˆå§‹çŠ¶æ€
<ClusterInitPage
  onComplete={handleClusterInitComplete}
  initialStatus={clusterStatus || undefined}
/>
```

**ClusterInitPageç»„ä»¶æ”¹è¿›**ï¼š

```typescript
// æ¥æ”¶åˆå§‹çŠ¶æ€ï¼Œé¿å…é‡å¤è°ƒç”¨
interface ClusterInitPageProps {
  onComplete: () => void;
  initialStatus?: ClusterStatusResponse;
}

// é€»è¾‘ä¼˜åŒ–
useEffect(() => {
  if (initialStatus) {
    // ä½¿ç”¨ä¼ å…¥çš„çŠ¶æ€ï¼Œä¸å†è°ƒç”¨API
    console.log("ä½¿ç”¨AppBootstrapä¼ å…¥çš„åˆå§‹çŠ¶æ€:", initialStatus);
    setClusterStatus(initialStatus);
    // ç›´æ¥å¤„ç†çŠ¶æ€...
    return;
  }

  // åªæœ‰æ²¡æœ‰åˆå§‹çŠ¶æ€æ—¶æ‰è°ƒç”¨API
  // ...
}, [initialStatus, onComplete, message]);
```

### 2. æœåŠ¡çº§åˆ«ç¼“å­˜

**æ·»åŠ ç¼“å­˜æœºåˆ¶**ï¼š

```typescript
class ClusterInitService {
  private statusCache: {
    data: ClusterStatusResponse;
    timestamp: number;
  } | null = null;
  private readonly CACHE_DURATION = 5000; // 5ç§’ç¼“å­˜

  async checkClusterStatus(): Promise<ClusterStatusResponse> {
    // æ£€æŸ¥ç¼“å­˜
    if (
      this.statusCache &&
      Date.now() - this.statusCache.timestamp < this.CACHE_DURATION
    ) {
      console.log("ğŸ“‹ ä½¿ç”¨ç¼“å­˜çš„é›†ç¾¤çŠ¶æ€");
      return this.statusCache.data;
    }

    // è°ƒç”¨APIå¹¶ç¼“å­˜ç»“æœ
    const result = await this.apiCall();
    this.statusCache = { data: result, timestamp: Date.now() };
    return result;
  }
}
```

### 3. è°ƒç”¨è·Ÿè¸ª

**æ·»åŠ è°ƒç”¨æ—¥å¿—**ï¼š

```typescript
async checkClusterStatus(): Promise<ClusterStatusResponse> {
  console.log("ğŸ” checkClusterStatus APIè°ƒç”¨ - æ¥æº:",
    new Error().stack?.split('\n')[2]?.trim()
  );
  // ...
}
```

## ğŸš€ ä¼˜åŒ–æ•ˆæœ

### è°ƒç”¨æ¬¡æ•°å‡å°‘

- **ä¼˜åŒ–å‰**ï¼š3-4æ¬¡é‡å¤è°ƒç”¨
- **ä¼˜åŒ–å**ï¼š1æ¬¡å®é™…APIè°ƒç”¨ï¼Œå…¶ä½™ä½¿ç”¨ç¼“å­˜æˆ–ä¼ é€’çŠ¶æ€

### æ€§èƒ½æå‡

1. **å‡å°‘ç½‘ç»œè¯·æ±‚**ï¼šé¿å…ä¸å¿…è¦çš„HTTPè¯·æ±‚
2. **æå‡å“åº”é€Ÿåº¦**ï¼šä½¿ç”¨ç¼“å­˜å’ŒçŠ¶æ€ä¼ é€’
3. **æ”¹å–„ç”¨æˆ·ä½“éªŒ**ï¼šå‡å°‘åŠ è½½æ—¶é—´

### ä»£ç å¯ç»´æŠ¤æ€§

1. **æ¸…æ™°çš„æ•°æ®æµ**ï¼šAppBootstrap â†’ ClusterInitPage
2. **ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†**ï¼šé¿å…çŠ¶æ€ä¸ä¸€è‡´
3. **è°ƒè¯•å‹å¥½**ï¼šæ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è·Ÿè¸ª

## ğŸ“Š æŠ€æœ¯è¦ç‚¹

### Reactæœ€ä½³å®è·µ

- âœ… åˆç†ä½¿ç”¨useEffectä¾èµ–
- âœ… é¿å…ä¸å¿…è¦çš„é‡å¤æ¸²æŸ“
- âœ… çŠ¶æ€æå‡å’Œä¼ é€’
- âœ… å¤„ç†StrictModeçš„åŒé‡æ‰§è¡Œ

### æœåŠ¡å±‚ä¼˜åŒ–

- âœ… æ·»åŠ ç¼“å­˜æœºåˆ¶
- âœ… è°ƒç”¨å»é‡å’ŒèŠ‚æµ
- âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘

### å¼€å‘ä½“éªŒ

- âœ… è¯¦ç»†çš„è°ƒç”¨æ—¥å¿—
- âœ… æ¸…æ™°çš„é—®é¢˜è¿½è¸ª
- âœ… æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

## ğŸ”§ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. å…¨å±€çŠ¶æ€ç®¡ç†

è€ƒè™‘ä½¿ç”¨Reduxæˆ–Zustandæ¥ç®¡ç†é›†ç¾¤çŠ¶æ€ï¼Œé¿å…props drillingã€‚

### 2. React Queryé›†æˆ

ä½¿ç”¨React Queryæ¥ç®¡ç†æœåŠ¡å™¨çŠ¶æ€ï¼Œè·å¾—æ›´å¥½çš„ç¼“å­˜å’ŒåŒæ­¥èƒ½åŠ›ã€‚

### 3. è¯·æ±‚å»é‡

åœ¨è¯·æ±‚å±‚é¢å®ç°å»é‡ï¼Œé¿å…å¹¶å‘çš„ç›¸åŒè¯·æ±‚ã€‚

### 4. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç§»é™¤è¯¦ç»†æ—¥å¿—ï¼Œåªä¿ç•™å¿…è¦çš„é”™è¯¯ä¿¡æ¯ã€‚

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å¼€å‘ç¯å¢ƒ

- APIè°ƒç”¨æ¬¡æ•°ï¼š1æ¬¡/é¡µé¢åŠ è½½
- ç¼“å­˜å‘½ä¸­ç‡ï¼š>80%
- å“åº”æ—¶é—´ï¼š<500ms

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

- ç›‘æ§APIè°ƒç”¨é¢‘ç‡
- è·Ÿè¸ªé”™è¯¯ç‡å’Œé‡è¯•æ¬¡æ•°
- æ€§èƒ½æŒ‡æ ‡é‡‡é›†

## ğŸ¯ æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–æªæ–½ï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†`checkClusterStatus`çš„é‡å¤è°ƒç”¨é—®é¢˜ï¼š

1. **æ ¹æœ¬åŸå› **ï¼šå¤šç»„ä»¶é‡å¤è°ƒç”¨å’ŒReactå¼€å‘æ¨¡å¼ç‰¹æ€§
2. **è§£å†³æ–¹æ¡ˆ**ï¼šçŠ¶æ€ä¼ é€’ + æœåŠ¡ç¼“å­˜ + è°ƒç”¨æ§åˆ¶
3. **ä¼˜åŒ–æ•ˆæœ**ï¼šAPIè°ƒç”¨æ¬¡æ•°ä»3-4æ¬¡å‡å°‘åˆ°1æ¬¡
4. **é™„åŠ ä»·å€¼**ï¼šæå‡äº†ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§

è¿™ç§ä¼˜åŒ–æ¨¡å¼å¯ä»¥åº”ç”¨åˆ°å…¶ä»–ç±»ä¼¼çš„APIè°ƒç”¨åœºæ™¯ä¸­ï¼Œå½¢æˆå¯å¤ç”¨çš„æœ€ä½³å®è·µã€‚
