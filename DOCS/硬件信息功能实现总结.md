# ç¡¬ä»¶ä¿¡æ¯åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æˆåŠŸä¸ºç‰©ç†ä¸»æœºè¯¦æƒ…é¡µé¢å®ç°äº†"ç¡¬ä»¶ä¿¡æ¯"Tabé¡µï¼Œæ”¯æŒæŸ¥çœ‹ç‰©ç†æœºçš„PCIè®¾å¤‡å’Œç£ç›˜è®¾å¤‡è¯¦ç»†ä¿¡æ¯ã€‚è¯¥åŠŸèƒ½é€šè¿‡ä¸¤ä¸ªæ–°çš„APIæ¥å£å®ç°ï¼š

- `/node/pcis` - è·å–PCIè®¾å¤‡åˆ—è¡¨
- `/node/disks` - è·å–ç£ç›˜è®¾å¤‡åˆ—è¡¨

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ç±»å‹å®šä¹‰æ›´æ–° (`/src/services/cluster/types.ts`)

#### PCIè®¾å¤‡ç›¸å…³ç±»å‹

```typescript
// PCIè®¾å¤‡ä¿¡æ¯ - ä¿®æ­£å­—æ®µå
export interface NodePCIDevice {
  slot: string; // PCIæ’æ§½ä½ç½®ï¼Œå¦‚ "0000:00:1f.2"
  vendor_name: string; // å‚å•†åç§°
  device_name: string; // è®¾å¤‡åç§°
  device_type: string; // è®¾å¤‡ç±»åˆ«ï¼Œå¦‚ "Mass storage controller"
  iommu_group?: number; // IOMMUç»„
  vendor_id: string; // å‚å•†IDï¼Œå¦‚ "8086"
  device_id: string; // è®¾å¤‡IDï¼Œå¦‚ "2922"
  // å…¶ä»–å¯é€‰å­—æ®µ...
}

// ç‰©ç†æœºPCIè®¾å¤‡åˆ—è¡¨è¯·æ±‚å‚æ•°
export interface NodePCIRequest {
  hostname: string;
}

// ç‰©ç†æœºPCIè®¾å¤‡åˆ—è¡¨å“åº”
export interface NodePCIResponse {
  hostname: string;
  devices: NodePCIDevice[];
}
```

#### ç£ç›˜è®¾å¤‡ç›¸å…³ç±»å‹

```typescript
// ç‰©ç†æœºç£ç›˜è®¾å¤‡åˆ—è¡¨è¯·æ±‚å‚æ•°
export interface NodeDisksRequest {
  hostname: string;
}

// ç‰©ç†æœºç£ç›˜è®¾å¤‡åˆ—è¡¨å“åº”
export interface NodeDisksResponse {
  devices: NodeDiskDeviceActual[];
}

// ç£ç›˜è®¾å¤‡ä¿¡æ¯
export interface NodeDiskDeviceActual {
  name: string; // è®¾å¤‡åç§°ï¼Œå¦‚ "/dev/sda"
  major_minor: string; // ä¸»æ¬¡è®¾å¤‡å·ï¼Œå¦‚ "8:0"
  removable: boolean; // æ˜¯å¦å¯ç§»åŠ¨
  size_gb: number; // å®¹é‡ï¼ˆGBï¼‰
  read_only: boolean; // æ˜¯å¦åªè¯»
  device_type: "disk" | "part" | "rom"; // è®¾å¤‡ç±»å‹
  mount_point: string; // æŒ‚è½½ç‚¹
  parent: string; // çˆ¶è®¾å¤‡
  filesystem: string; // æ–‡ä»¶ç³»ç»Ÿ
  total_size_gb: number; // æ€»å®¹é‡ï¼ˆGBï¼‰
  used_size_gb: number; // å·²ç”¨å®¹é‡ï¼ˆGBï¼‰
  available_size_gb: number; // å¯ç”¨å®¹é‡ï¼ˆGBï¼‰
  percentage_value: number; // ä½¿ç”¨ç™¾åˆ†æ¯”
}
```

### 2. æœåŠ¡å±‚å®ç° (`/src/services/cluster/index.ts`)

#### APIæ–¹æ³•å®ç°

```typescript
/**
 * è·å–ç‰©ç†æœºPCIè®¾å¤‡åˆ—è¡¨
 */
async getNodePCIDevices(hostname: string): Promise<StandardResponse<NodePCIResponse>> {
  if (USE_MOCK_DATA) {
    return mockApi.post('/node/pcis', { hostname }, {
      useMock: true,
      mockData: this.getMockNodePCIDevices(hostname),
      defaultSuccessMessage: "è·å–PCIè®¾å¤‡åˆ—è¡¨æˆåŠŸ",
    });
  }

  return api.post<NodePCIResponse>('/node/pcis', { hostname }, {
    skipAuth: false,
    defaultSuccessMessage: "è·å–PCIè®¾å¤‡åˆ—è¡¨æˆåŠŸ",
    defaultErrorMessage: "è·å–PCIè®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",
  });
}

/**
 * è·å–ç‰©ç†æœºç¡¬ç›˜è®¾å¤‡åˆ—è¡¨
 */
async getNodeDiskDevices(hostname: string): Promise<StandardResponse<NodeDisksResponse>> {
  if (USE_MOCK_DATA) {
    return mockApi.post('/node/disks', { hostname }, {
      useMock: true,
      mockData: this.getMockNodeDiskDevices(hostname),
      defaultSuccessMessage: "è·å–ç¡¬ç›˜è®¾å¤‡åˆ—è¡¨æˆåŠŸ",
    });
  }

  return api.post<NodeDisksResponse>('/node/disks', { hostname }, {
    skipAuth: false,
    defaultSuccessMessage: "è·å–ç¡¬ç›˜è®¾å¤‡åˆ—è¡¨æˆåŠŸ",
    defaultErrorMessage: "è·å–ç¡¬ç›˜è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",
  });
}
```

#### Mockæ•°æ®å®ç°

- å®Œæ•´çš„PCIè®¾å¤‡æ¨¡æ‹Ÿæ•°æ®ï¼ŒåŒ…å«ä¸»æµå‚å•†è®¾å¤‡ï¼ˆIntelã€Broadcomã€LSIç­‰ï¼‰
- å®Œæ•´çš„ç£ç›˜è®¾å¤‡æ¨¡æ‹Ÿæ•°æ®ï¼ŒåŒ…å«ç³»ç»Ÿç›˜ã€æ•°æ®ç›˜ã€å…‰é©±ç­‰ä¸åŒç±»å‹è®¾å¤‡
- çœŸå®çš„è®¾å¤‡ä¿¡æ¯æ ¼å¼ï¼ŒåŒ…å«æŒ‚è½½ç‚¹ã€æ–‡ä»¶ç³»ç»Ÿã€ä½¿ç”¨ç‡ç­‰ä¿¡æ¯

### 3. å‰ç«¯é¡µé¢å®ç° (`/src/pages/Cluster/index.tsx`)

#### çŠ¶æ€ç®¡ç†

```typescript
// ç¡¬ä»¶ä¿¡æ¯ç›¸å…³çŠ¶æ€ - PCIè®¾å¤‡
const [nodePCIData, setNodePCIData] = useState<NodePCIResponse | null>(null);
const [nodePCILoading, setNodePCILoading] = useState(false);
const [nodePCIError, setNodePCIError] = useState<string | null>(null);

// ç¡¬ä»¶ä¿¡æ¯ç›¸å…³çŠ¶æ€ - ç£ç›˜è®¾å¤‡
const [nodeDisksData, setNodeDisksData] = useState<NodeDisksResponse | null>(
  null,
);
const [nodeDisksLoading, setNodeDisksLoading] = useState(false);
const [nodeDisksError, setNodeDisksError] = useState<string | null>(null);
```

#### APIè°ƒç”¨å‡½æ•°

```typescript
// è·å–èŠ‚ç‚¹PCIè®¾å¤‡ä¿¡æ¯åŸºç¡€å‡½æ•°
const fetchNodePCIDataBase = useCallback(
  async (hostname: string) => {
    // å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
    const result = await clusterInitService.getNodePCIDevices(hostname);
    // ...å¤„ç†å“åº”
  },
  [message],
);

// è·å–èŠ‚ç‚¹ç£ç›˜è®¾å¤‡ä¿¡æ¯åŸºç¡€å‡½æ•°
const fetchNodeDisksDataBase = useCallback(
  async (hostname: string) => {
    // å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
    const result = await clusterInitService.getNodeDiskDevices(hostname);
    // ...å¤„ç†å“åº”
  },
  [message],
);

// ä½¿ç”¨APIé”åŒ…è£…çš„ç¡¬ä»¶ä¿¡æ¯è·å–å‡½æ•°
const fetchNodePCIData = useMemo(
  () => withApiLock("fetchNodePCIData", fetchNodePCIDataBase),
  [withApiLock, fetchNodePCIDataBase],
);

const fetchNodeDisksData = useMemo(
  () => withApiLock("fetchNodeDisksData", fetchNodeDisksDataBase),
  [withApiLock, fetchNodeDisksDataBase],
);
```

#### è‡ªåŠ¨åŠ è½½æœºåˆ¶

```typescript
// ç›‘å¬ä¸»æœºé€‰æ‹©å˜åŒ–ï¼Œè‡ªåŠ¨è·å–è¯¦ç»†ä¿¡æ¯å’Œç¡¬ä»¶ä¿¡æ¯
useEffect(() => {
  if (sidebarSelectedHost) {
    console.log(
      `ğŸ” [Node Detail] å¼€å§‹è·å–ä¸»æœº ${sidebarSelectedHost.name} çš„è¯¦ç»†ä¿¡æ¯`,
    );
    // è·å–åŸºæœ¬èŠ‚ç‚¹ä¿¡æ¯
    fetchNodeDetailData(sidebarSelectedHost.name);

    // è‡ªåŠ¨åŠ è½½ç¡¬ä»¶ä¿¡æ¯
    console.log(
      `ğŸ”§ [Hardware Info] è‡ªåŠ¨åŠ è½½ä¸»æœº ${sidebarSelectedHost.name} çš„ç¡¬ä»¶ä¿¡æ¯`,
    );
    fetchNodePCIData(sidebarSelectedHost.name);
    fetchNodeDisksData(sidebarSelectedHost.name);
  }
}, [
  sidebarSelectedHost,
  fetchNodeDetailData,
  fetchNodePCIData,
  fetchNodeDisksData,
]);
```

#### UIç»„ä»¶å®ç°

##### ç¡¬ä»¶ä¿¡æ¯Tabé¡µ

```typescript
{
  key: "hardware",
  label: "ç¡¬ä»¶ä¿¡æ¯",
  children: (
    <div>
      <Row gutter={[16, 16]}>
        {/* PCIè®¾å¤‡ä¿¡æ¯ */}
        <Col span={24}>
          <Card title={<Space><SettingOutlined /><span>PCIè®¾å¤‡åˆ—è¡¨</span></Space>}>
            {/* PCIè®¾å¤‡è¡¨æ ¼ */}
          </Card>
        </Col>

        {/* ç£ç›˜è®¾å¤‡ä¿¡æ¯ */}
        <Col span={24}>
          <Card title={<Space><AppstoreOutlined /><span>ç£ç›˜è®¾å¤‡åˆ—è¡¨</span></Space>}>
            {/* ç£ç›˜è®¾å¤‡è¡¨æ ¼ */}
          </Card>
        </Col>
      </Row>
    </div>
  ),
},
```

##### PCIè®¾å¤‡è¡¨æ ¼

- **æ’æ§½åˆ—**ï¼šæ˜¾ç¤ºPCIæ’æ§½ä½ç½®ï¼Œä½¿ç”¨è“è‰²Tagæ ‡ç­¾
- **å‚å•†åˆ—**ï¼šæ˜¾ç¤ºè®¾å¤‡å‚å•†åç§°ï¼Œæ”¯æŒæ–‡æœ¬çœç•¥
- **è®¾å¤‡åç§°åˆ—**ï¼šæ˜¾ç¤ºè®¾å¤‡å…·ä½“åç§°ï¼Œæ”¯æŒæ–‡æœ¬çœç•¥
- **è®¾å¤‡ç±»å‹åˆ—**ï¼šæ˜¾ç¤ºè®¾å¤‡ç±»åˆ«ï¼Œä½¿ç”¨ç»¿è‰²Tagæ ‡ç­¾
- **IOMMUç»„åˆ—**ï¼šæ˜¾ç¤ºIOMMUç»„å·ï¼Œä½¿ç”¨æ©™è‰²Tagæ ‡ç­¾

##### ç£ç›˜è®¾å¤‡è¡¨æ ¼

- **è®¾å¤‡åç§°åˆ—**ï¼šæ˜¾ç¤ºè®¾å¤‡è·¯å¾„ï¼Œä½¿ç”¨è“è‰²Tagæ ‡ç­¾
- **å¤§å°åˆ—**ï¼šæ ¼å¼åŒ–æ˜¾ç¤ºè®¾å¤‡å®¹é‡ï¼ˆGBï¼‰
- **ç±»å‹åˆ—**ï¼šæ˜¾ç¤ºè®¾å¤‡ç±»å‹ï¼ˆdisk/part/romï¼‰ï¼Œä½¿ç”¨ä¸åŒé¢œè‰²Tagæ ‡ç­¾
- **æŒ‚è½½ç‚¹åˆ—**ï¼šæ˜¾ç¤ºæŒ‚è½½è·¯å¾„
- **ä½¿ç”¨ç‡åˆ—**ï¼šä½¿ç”¨Progressè¿›åº¦æ¡å¯è§†åŒ–æ˜¾ç¤ºï¼Œæ”¯æŒé¢œè‰²æ¸å˜
- **æ–‡ä»¶ç³»ç»Ÿåˆ—**ï¼šæ˜¾ç¤ºæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œä½¿ç”¨é’è‰²Tagæ ‡ç­¾

#### äº¤äº’åŠŸèƒ½

- **åŠ è½½çŠ¶æ€**ï¼šæ˜¾ç¤ºSpinç»„ä»¶å’ŒåŠ è½½æç¤ºæ–‡å­—
- **é”™è¯¯å¤„ç†**ï¼šæ˜¾ç¤ºAlerté”™è¯¯æç¤ºç»„ä»¶
- **ç©ºæ•°æ®å¤„ç†**ï¼šæ˜¾ç¤ºEmptyç»„ä»¶æç¤ºæš‚æ— æ•°æ®
- **åˆ·æ–°åŠŸèƒ½**ï¼šæ¯ä¸ªç¡¬ä»¶ç»„ä»¶ç‹¬ç«‹çš„åˆ·æ–°æŒ‰é’®
- **åˆ†é¡µæ”¯æŒ**ï¼šè¡¨æ ¼æ”¯æŒåˆ†é¡µå’Œé¡µé¢å¤§å°è°ƒæ•´

## ğŸ¨ UIè®¾è®¡ç‰¹è‰²

### 1. å“åº”å¼å¸ƒå±€

- ä½¿ç”¨Ant Designçš„Gridç³»ç»Ÿç¡®ä¿åœ¨ä¸åŒå±å¹•å°ºå¯¸ä¸‹æ­£å¸¸æ˜¾ç¤º
- è¡¨æ ¼æ”¯æŒæ¨ªå‘æ»šåŠ¨ï¼Œé˜²æ­¢å†…å®¹è¢«æˆªæ–­

### 2. æ•°æ®å¯è§†åŒ–

- **Tagæ ‡ç­¾**ï¼šç”¨ä¸åŒé¢œè‰²åŒºåˆ†è®¾å¤‡ç±»å‹ã€çŠ¶æ€ç­‰ä¿¡æ¯
- **Progressè¿›åº¦æ¡**ï¼šç›´è§‚æ˜¾ç¤ºç£ç›˜ä½¿ç”¨ç‡
- **å›¾æ ‡**ï¼šä½¿ç”¨è¯­ä¹‰åŒ–å›¾æ ‡æå‡ç”¨æˆ·ä½“éªŒ

### 3. äº¤äº’ä½“éªŒ

- **å®æ—¶åŠ è½½**ï¼šé€‰æ‹©ä¸»æœºåè‡ªåŠ¨åŠ è½½ç¡¬ä»¶ä¿¡æ¯
- **ç‹¬ç«‹åˆ·æ–°**ï¼šPCIå’Œç£ç›˜è®¾å¤‡æ”¯æŒç‹¬ç«‹åˆ·æ–°
- **é”™è¯¯åé¦ˆ**ï¼šå®Œå–„çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶
- **ç©ºçŠ¶æ€å¤„ç†**ï¼šå‹å¥½çš„ç©ºæ•°æ®æç¤º

### 4. æ€§èƒ½ä¼˜åŒ–

- **APIé”æœºåˆ¶**ï¼šé˜²æ­¢é‡å¤APIè°ƒç”¨
- **useMemoä¼˜åŒ–**ï¼šä¼˜åŒ–å‡½æ•°é‡å¤åˆ›å»º
- **useCallbackä¼˜åŒ–**ï¼šä¼˜åŒ–å›è°ƒå‡½æ•°æ€§èƒ½

## ğŸ§ª æµ‹è¯•è¯´æ˜

### Mockæ•°æ®æµ‹è¯•

å½“å‰å®ç°æ”¯æŒå®Œæ•´çš„Mockæ•°æ®æµ‹è¯•ï¼š

1. **ç¯å¢ƒé…ç½®**ï¼šè®¾ç½® `VITE_ENABLE_MOCK=true` å¯ç”¨Mockæ•°æ®
2. **PCIè®¾å¤‡Mockæ•°æ®**ï¼š
   - Intel SATAæ§åˆ¶å™¨
   - Intelæ˜¾å¡æ§åˆ¶å™¨
   - Intel USBæ§åˆ¶å™¨
   - Broadcomç½‘å¡
   - LSI SASæ§åˆ¶å™¨

3. **ç£ç›˜è®¾å¤‡Mockæ•°æ®**ï¼š
   - ç³»ç»Ÿç›˜åˆ†åŒºï¼ˆ/dev/sda, /dev/sda1, /dev/sda2ï¼‰
   - æ•°æ®ç›˜ï¼ˆ/dev/sdbï¼‰
   - å…‰é©±è®¾å¤‡ï¼ˆ/dev/sr0ï¼‰

### çœŸå®APIæµ‹è¯•

åˆ‡æ¢åˆ°çœŸå®APIæ¨¡å¼ï¼ˆ`VITE_ENABLE_MOCK=false`ï¼‰å³å¯æµ‹è¯•çœŸå®åç«¯æ¥å£ã€‚

## ğŸ”„ APIæ¥å£è§„èŒƒ

### POST /node/pcis

**è¯·æ±‚å‚æ•°ï¼š**

```json
{
  "hostname": "string"
}
```

**å“åº”æ ¼å¼ï¼š**

```json
{
  "hostname": "localhost.localdomain",
  "devices": [
    {
      "slot": "0000:00:1f.2",
      "vendor_id": "8086",
      "device_id": "2922",
      "vendor_name": "Intel Corporation",
      "device_name": "6 Series/C200 Series Chipset Family SATA AHCI Controller",
      "device_type": "SATA controller",
      "iommu_group": 15
    }
  ]
}
```

### POST /node/disks

**è¯·æ±‚å‚æ•°ï¼š**

```json
{
  "hostname": "string"
}
```

**å“åº”æ ¼å¼ï¼š**

```json
{
  "devices": [
    {
      "name": "/dev/sda",
      "major_minor": "8:0",
      "removable": false,
      "size_gb": 500,
      "read_only": false,
      "device_type": "disk",
      "mount_point": "",
      "parent": "",
      "filesystem": "",
      "total_size_gb": 500,
      "used_size_gb": 250,
      "available_size_gb": 250,
      "percentage_value": 50
    }
  ]
}
```

## ğŸš€ ä½¿ç”¨è¯´æ˜

### è®¿é—®ç¡¬ä»¶ä¿¡æ¯

1. åœ¨é›†ç¾¤ç®¡ç†é¡µé¢ï¼Œä»ä¾§è¾¹æ é€‰æ‹©ä¸€ä¸ªç‰©ç†ä¸»æœº
2. ä¸»æœºè¯¦æƒ…é¡µé¢ä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼Œç‚¹å‡»"ç¡¬ä»¶ä¿¡æ¯"Tabé¡µ
3. ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½PCIè®¾å¤‡å’Œç£ç›˜è®¾å¤‡ä¿¡æ¯
4. å¯ä»¥ä½¿ç”¨å„ä¸ªç»„ä»¶çš„åˆ·æ–°æŒ‰é’®é‡æ–°åŠ è½½æ•°æ®

### æ•…éšœæ’é™¤

- **æ•°æ®ä¸æ˜¾ç¤º**ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œåç«¯APIæ˜¯å¦æ­£å¸¸
- **åŠ è½½ç¼“æ…¢**ï¼šAPIè°ƒç”¨æœ‰é˜²é‡å¤æœºåˆ¶ï¼Œè€å¿ƒç­‰å¾…
- **é”™è¯¯æç¤º**ï¼šæŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Œç‚¹å‡»åˆ·æ–°æŒ‰é’®é‡è¯•

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜æœºåˆ¶**ï¼šè€ƒè™‘æ·»åŠ ç¡¬ä»¶ä¿¡æ¯ç¼“å­˜ï¼Œé¿å…é¢‘ç¹APIè°ƒç”¨
2. **å¯¼å‡ºåŠŸèƒ½**ï¼šæ”¯æŒå¯¼å‡ºç¡¬ä»¶ä¿¡æ¯æŠ¥å‘Š
3. **è¯¦ç»†è§†å›¾**ï¼šç‚¹å‡»è®¾å¤‡è¡Œæ˜¾ç¤ºæ›´è¯¦ç»†çš„è®¾å¤‡ä¿¡æ¯
4. **è®¾å¤‡ç›‘æ§**ï¼šé›†æˆè®¾å¤‡å¥åº·çŠ¶æ€å’Œæ¸©åº¦ç›‘æ§
5. **å†å²è®°å½•**ï¼šè®°å½•ç¡¬ä»¶å˜æ›´å†å²

## ğŸ¯ æ€»ç»“

ç¡¬ä»¶ä¿¡æ¯åŠŸèƒ½å·²å®Œå…¨é›†æˆåˆ°ç‰©ç†ä¸»æœºè¯¦æƒ…é¡µé¢ï¼Œæä¾›äº†å®Œæ•´çš„PCIè®¾å¤‡å’Œç£ç›˜è®¾å¤‡æŸ¥çœ‹èƒ½åŠ›ã€‚è¯¥åŠŸèƒ½å…·æœ‰è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œæ”¯æŒMockæ•°æ®æµ‹è¯•å’ŒçœŸå®APIè°ƒç”¨ï¼Œä¸ºç³»ç»Ÿç®¡ç†å‘˜æä¾›äº†å¼ºå¤§çš„ç¡¬ä»¶ç®¡ç†å·¥å…·ã€‚
