# é›†ç¾¤ç®¡ç†æ¨¡å—æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è§ˆ](#åŠŸèƒ½æ¦‚è§ˆ)
2. [åç«¯APIæ¥å£åˆ†æ](#åç«¯apiæ¥å£åˆ†æ)
3. [ç›¸å…³ä¾èµ–æ¨¡å—](#ç›¸å…³ä¾èµ–æ¨¡å—)
4. [æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†](#æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†)
5. [æŠ€æœ¯å®ç°ç»†èŠ‚](#æŠ€æœ¯å®ç°ç»†èŠ‚)
6. [æ€§èƒ½ä¼˜åŒ–æªæ–½](#æ€§èƒ½ä¼˜åŒ–æªæ–½)
7. [é”™è¯¯å¤„ç†æœºåˆ¶](#é”™è¯¯å¤„ç†æœºåˆ¶)

---

## 1. åŠŸèƒ½æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒåŠŸèƒ½åˆ—è¡¨

é›†ç¾¤ç®¡ç†æ¨¡å— (`src/pages/Cluster/index.tsx`) æ˜¯ KR-virt è™šæ‹ŸåŒ–å¹³å°çš„æ ¸å¿ƒç»„ä»¶ï¼Œæä¾›ä»¥ä¸‹ä¸»è¦åŠŸèƒ½ï¼š

#### ğŸ—ï¸ é›†ç¾¤ç®¡ç†åŠŸèƒ½
- **é›†ç¾¤æ¦‚è§ˆ**: æ˜¾ç¤ºé›†ç¾¤åŸºæœ¬ä¿¡æ¯ã€èŠ‚ç‚¹çŠ¶æ€ã€èµ„æºç»Ÿè®¡
- **ç‰©ç†æœºåˆ—è¡¨**: ç®¡ç†é›†ç¾¤ä¸­çš„ç‰©ç†èŠ‚ç‚¹ï¼Œæ”¯æŒæ·»åŠ /ç§»é™¤èŠ‚ç‚¹
- **é›†ç¾¤èµ„æº**: æŸ¥çœ‹å’Œç®¡ç†é›†ç¾¤èµ„æºé…ç½®
- **è§£æ•£é›†ç¾¤**: å®‰å…¨è§£æ•£æ•´ä¸ªé›†ç¾¤

#### ğŸ–¥ï¸ ä¸»æœºç®¡ç†åŠŸèƒ½
- **ä¸»æœºè¯¦æƒ…**: æŸ¥çœ‹ä¸»æœºæ€§èƒ½æŒ‡æ ‡ã€ç³»ç»Ÿä¿¡æ¯ã€è™šæ‹Ÿæœºç»Ÿè®¡
- **ä¸»æœºæ“ä½œ**: é‡å¯ã€å…³æœºã€è¿›å…¥/é€€å‡ºç»´æŠ¤æ¨¡å¼ã€è™šæ‹Ÿæœºè¿ç§»
- **ç¡¬ä»¶ä¿¡æ¯**: æŒ‰éœ€åŠ è½½PCIè®¾å¤‡ã€ç£ç›˜è®¾å¤‡ä¿¡æ¯
- **æ€§èƒ½ç›‘æ§**: CPUã€å†…å­˜ã€å­˜å‚¨ã€ç½‘ç»œæ€§èƒ½å›¾è¡¨

#### ğŸ’» è™šæ‹Ÿæœºç®¡ç†åŠŸèƒ½
- **è™šæ‹Ÿæœºè¯¦æƒ…**: æŸ¥çœ‹è™šæ‹ŸæœºåŸºæœ¬é…ç½®ã€ç¡¬ä»¶é…ç½®
- **çŠ¶æ€ç®¡ç†**: è™šæ‹ŸæœºçŠ¶æ€ç›‘æ§å’Œæ“ä½œ
- **æ§åˆ¶å°è®¿é—®**: è™šæ‹Ÿæœºæ§åˆ¶å°ç®¡ç†

### 1.2 ç”¨æˆ·ç•Œé¢ç»„ä»¶ç»“æ„

```
ClusterManagement (ä¸»ç»„ä»¶)
â”œâ”€â”€ é›†ç¾¤ç®¡ç†ä¸»é¡µé¢
â”‚   â”œâ”€â”€ é¡µé¢å¤´éƒ¨ (æ ‡é¢˜ + æ“ä½œæŒ‰é’®)
â”‚   â””â”€â”€ æ ‡ç­¾é¡µå®¹å™¨
â”‚       â”œâ”€â”€ é›†ç¾¤æ¦‚è§ˆ Tab
â”‚       â”‚   â”œâ”€â”€ é›†ç¾¤åŸºæœ¬ä¿¡æ¯å¡ç‰‡
â”‚       â”‚   â”œâ”€â”€ ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ç»„
â”‚       â”‚   â”œâ”€â”€ èŠ‚ç‚¹åˆ—è¡¨è¡¨æ ¼
â”‚       â”‚   â”œâ”€â”€ èµ„æºåˆ—è¡¨è¡¨æ ¼
â”‚       â”‚   â””â”€â”€ å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€å¡ç‰‡
â”‚       â”œâ”€â”€ ç‰©ç†æœºåˆ—è¡¨ Tab
â”‚       â”‚   â”œâ”€â”€ ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ç»„
â”‚       â”‚   â””â”€â”€ ç‰©ç†æœºèŠ‚ç‚¹è¡¨æ ¼
â”‚       â””â”€â”€ é›†ç¾¤èµ„æº Tab
â”‚           â”œâ”€â”€ èµ„æºç»Ÿè®¡æ¦‚è§ˆ
â”‚           â””â”€â”€ èµ„æºè¯¦æƒ…è¡¨æ ¼
â”œâ”€â”€ ä¸»æœºè¯¦æƒ…é¡µé¢ (æ¡ä»¶æ¸²æŸ“)
â”‚   â”œâ”€â”€ é¡µé¢å¤´éƒ¨ (ä¸»æœºä¿¡æ¯ + æ“ä½œæŒ‰é’®)
â”‚   â”œâ”€â”€ ä¸»æœºæ“ä½œå¡ç‰‡
â”‚   â””â”€â”€ è¯¦æƒ…æ ‡ç­¾é¡µ
â”‚       â”œâ”€â”€ åŸºæœ¬ä¿¡æ¯ Tab
â”‚       â”œâ”€â”€ æ€§èƒ½ç›‘æ§ Tab
â”‚       â””â”€â”€ ç¡¬ä»¶ä¿¡æ¯ Tab
â””â”€â”€ è™šæ‹Ÿæœºè¯¦æƒ…é¡µé¢ (æ¡ä»¶æ¸²æŸ“)
    â”œâ”€â”€ é¡µé¢å¤´éƒ¨ (è™šæ‹Ÿæœºä¿¡æ¯ + æ“ä½œæŒ‰é’®)
    â””â”€â”€ è¯¦æƒ…æ ‡ç­¾é¡µ
        â”œâ”€â”€ åŸºæœ¬ä¿¡æ¯ Tab
        â””â”€â”€ æ“ä½œæ—¥å¿— Tab
```

### 1.3 ä¸»è¦ä¸šåŠ¡æµç¨‹

#### é›†ç¾¤ç®¡ç†æµç¨‹
```mermaid
graph TD
    A[è¿›å…¥é›†ç¾¤ç®¡ç†] --> B[åŠ è½½é›†ç¾¤æ¦‚è§ˆ]
    B --> C{é€‰æ‹©æ“ä½œ}
    C -->|æŸ¥çœ‹è¯¦æƒ…| D[åˆ‡æ¢æ ‡ç­¾é¡µ]
    C -->|æ·»åŠ èŠ‚ç‚¹| E[æ‰“å¼€æ·»åŠ èŠ‚ç‚¹æ¨¡æ€æ¡†]
    C -->|è§£æ•£é›†ç¾¤| F[å®‰å…¨ç¡®è®¤æµç¨‹]
    D --> G[æŒ‰éœ€åŠ è½½æ•°æ®]
    E --> H[æäº¤èŠ‚ç‚¹ä¿¡æ¯]
    F --> I[æ‰§è¡Œè§£æ•£æ“ä½œ]
```

#### ä¸»æœºç®¡ç†æµç¨‹
```mermaid
graph TD
    A[ä¾§è¾¹æ é€‰æ‹©ä¸»æœº] --> B[åŠ è½½ä¸»æœºè¯¦æƒ…]
    B --> C[æ˜¾ç¤ºä¸»æœºè¯¦æƒ…é¡µé¢]
    C --> D{ç”¨æˆ·æ“ä½œ}
    D -->|åˆ‡æ¢æ ‡ç­¾| E[æŒ‰éœ€åŠ è½½ç¡¬ä»¶ä¿¡æ¯]
    D -->|ä¸»æœºæ“ä½œ| F[ç¡®è®¤æ“ä½œ]
    D -->|åˆ·æ–°æ•°æ®| G[é‡æ–°åŠ è½½ä¸»æœºä¿¡æ¯]
    F --> H[æ‰§è¡Œä¸»æœºæ“ä½œ]
    H --> I[æ›´æ–°ä¸»æœºçŠ¶æ€]
```

---

## 2. åç«¯APIæ¥å£åˆ†æ

### 2.1 é›†ç¾¤ç®¡ç†ç›¸å…³æ¥å£

#### è·å–é›†ç¾¤æ¦‚è§ˆ
- **URL**: `GET /cluster/summary`
- **ç”¨é€”**: è·å–é›†ç¾¤åŸºæœ¬ä¿¡æ¯å’Œç»Ÿè®¡æ•°æ®
- **è°ƒç”¨æ—¶æœº**: åˆ‡æ¢åˆ°é›†ç¾¤æ¦‚è§ˆæ ‡ç­¾é¡µæ—¶
- **è¯·æ±‚å‚æ•°**: æ— 
- **å“åº”æ ¼å¼**:
```typescript
interface ClusterSummaryResponse {
  cluster_name: string;           // é›†ç¾¤åç§°
  stack: string;                  // æŠ€æœ¯æ ˆ
  dc_node: string;               // DCèŠ‚ç‚¹
  dc_version: string;            // DCç‰ˆæœ¬
  dc_quorum: string;             // ä»²è£çŠ¶æ€
  last_updated: string;          // æœ€åæ›´æ–°æ—¶é—´
  last_change_time: string;      // æœ€åå˜æ›´æ—¶é—´
  last_change_user: string;      // å˜æ›´ç”¨æˆ·
  last_change_via: string;       // å˜æ›´æ–¹å¼
  last_change_node: string;      // å˜æ›´èŠ‚ç‚¹
  nodes_configured: number;       // é…ç½®èŠ‚ç‚¹æ•°
  resources_configured: number;   // é…ç½®èµ„æºæ•°
  nodes: ClusterSummaryNode[];   // èŠ‚ç‚¹åˆ—è¡¨
  resources: ClusterSummaryResource[]; // èµ„æºåˆ—è¡¨
  daemons: Record<string, string>; // å®ˆæŠ¤è¿›ç¨‹çŠ¶æ€
}
```

#### è·å–é›†ç¾¤èŠ‚ç‚¹åˆ—è¡¨
- **URL**: `GET /cluster/nodes`
- **ç”¨é€”**: è·å–é›†ç¾¤ä¸­æ‰€æœ‰ç‰©ç†èŠ‚ç‚¹ä¿¡æ¯
- **è°ƒç”¨æ—¶æœº**: åˆ‡æ¢åˆ°ç‰©ç†æœºåˆ—è¡¨æ ‡ç­¾é¡µæ—¶
- **è¯·æ±‚å‚æ•°**: æ— 
- **å“åº”æ ¼å¼**:
```typescript
interface ClusterNodesResponse {
  cluster_name: string;
  cluster_uuid: string;
  nodes: ClusterNode[];
}

interface ClusterNode {
  name: string;                  // èŠ‚ç‚¹åç§°
  node_id: string;              // èŠ‚ç‚¹ID
  ip: string;                   // IPåœ°å€
  status: string;               // èŠ‚ç‚¹çŠ¶æ€
  is_dc: boolean;               // æ˜¯å¦ä¸ºDCèŠ‚ç‚¹
  cpu_total: number | null;     // CPUæ€»é‡
  mem_total: number | null;     // å†…å­˜æ€»é‡
  cpu_used: number | null;      // CPUä½¿ç”¨é‡
  mem_used: number | null;      // å†…å­˜ä½¿ç”¨é‡
  pub_key: string;              // SSHå…¬é’¥
}
```

#### è·å–é›†ç¾¤èµ„æº
- **URL**: `GET /cluster/resources`
- **ç”¨é€”**: è·å–é›†ç¾¤èµ„æºé…ç½®ä¿¡æ¯
- **è°ƒç”¨æ—¶æœº**: åˆ‡æ¢åˆ°é›†ç¾¤èµ„æºæ ‡ç­¾é¡µæ—¶
- **è¯·æ±‚å‚æ•°**: æ— 
- **å“åº”æ ¼å¼**:
```typescript
interface ClusterResourcesResponse {
  resources: ClusterResource[];
}

interface ClusterResource {
  id: string;                   // èµ„æºID
  class_: string;              // èµ„æºç±»åˆ«
  provider: string;            // æä¾›è€…
  type: string;                // èµ„æºç±»å‹
  attributes: Record<string, string>; // å±æ€§
  operations: ResourceOperation[];    // æ“ä½œåˆ—è¡¨
}
```

### 2.2 èŠ‚ç‚¹ç®¡ç†ç›¸å…³æ¥å£

#### è·å–èŠ‚ç‚¹è¯¦æƒ…
- **URL**: `GET /node/summary`
- **ç”¨é€”**: è·å–æŒ‡å®šèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯
- **è°ƒç”¨æ—¶æœº**: é€‰æ‹©ä¸»æœºæ—¶è‡ªåŠ¨è°ƒç”¨
- **è¯·æ±‚å‚æ•°**: `hostname` (æŸ¥è¯¢å‚æ•°)
- **å“åº”æ ¼å¼**:
```typescript
interface NodeSummaryResponse {
  node_name: string;            // èŠ‚ç‚¹åç§°
  cluster_name: string;        // é›†ç¾¤åç§°
  power_state: string;         // ç”µæºçŠ¶æ€
  running_time: number;        // è¿è¡Œæ—¶é—´(ç§’)
  cpu_total: number;           // CPUæ€»é‡
  cpu_used: number;            // CPUä½¿ç”¨é‡
  mem_total: number;           // å†…å­˜æ€»é‡(MB)
  mem_used: number;            // å†…å­˜ä½¿ç”¨é‡(MB)
  disk_total: number;          // ç£ç›˜æ€»é‡(GB)
  disk_used: number;           // ç£ç›˜ä½¿ç”¨é‡(GB)
  storage_total: number;       // å­˜å‚¨æ€»é‡(GB)
  storage_used: number;        // å­˜å‚¨ä½¿ç”¨é‡(GB)
  vms_num: number;             // è™šæ‹Ÿæœºæ€»æ•°
  running_vm_num: number;      // è¿è¡Œä¸­è™šæ‹Ÿæœºæ•°
  stopped_vm_num: number;      // åœæ­¢è™šæ‹Ÿæœºæ•°
  paused_vm_num: number;       // æš‚åœè™šæ‹Ÿæœºæ•°
  suspended_vm_num: number;    // æŒ‚èµ·è™šæ‹Ÿæœºæ•°
  error_vm_num: number;        // å¼‚å¸¸è™šæ‹Ÿæœºæ•°
  vm_max_allowed: number;      // æœ€å¤§å…è®¸è™šæ‹Ÿæœºæ•°
}
```

#### èŠ‚ç‚¹æ“ä½œæ¥å£
- **é‡å¯èŠ‚ç‚¹**: `POST /node/reboot`
- **å…³é—­èŠ‚ç‚¹**: `POST /node/shutdown`
- **è¿›å…¥ç»´æŠ¤æ¨¡å¼**: `POST /node/maintenance/enter`
- **é€€å‡ºç»´æŠ¤æ¨¡å¼**: `POST /node/maintenance/exit`
- **è¯·æ±‚å‚æ•°**: `{ hostname: string }`
- **å“åº”æ ¼å¼**: `{ success: boolean; message: string }`

### 2.3 ç¡¬ä»¶ä¿¡æ¯ç›¸å…³æ¥å£

#### è·å–PCIè®¾å¤‡ä¿¡æ¯
- **URL**: `GET /node/pci`
- **ç”¨é€”**: è·å–èŠ‚ç‚¹PCIè®¾å¤‡åˆ—è¡¨
- **è°ƒç”¨æ—¶æœº**: åˆ‡æ¢åˆ°ç¡¬ä»¶ä¿¡æ¯æ ‡ç­¾é¡µæ—¶æŒ‰éœ€åŠ è½½
- **è¯·æ±‚å‚æ•°**: `hostname` (æŸ¥è¯¢å‚æ•°)

#### è·å–ç£ç›˜è®¾å¤‡ä¿¡æ¯
- **URL**: `GET /node/disks`
- **ç”¨é€”**: è·å–èŠ‚ç‚¹ç£ç›˜è®¾å¤‡ä¿¡æ¯
- **è°ƒç”¨æ—¶æœº**: åˆ‡æ¢åˆ°ç¡¬ä»¶ä¿¡æ¯æ ‡ç­¾é¡µæ—¶æŒ‰éœ€åŠ è½½
- **è¯·æ±‚å‚æ•°**: `hostname` (æŸ¥è¯¢å‚æ•°)

### 2.4 é›†ç¾¤æ“ä½œæ¥å£

#### æ·»åŠ èŠ‚ç‚¹
- **URL**: `POST /cluster/approve`
- **ç”¨é€”**: æ·»åŠ æ–°èŠ‚ç‚¹åˆ°é›†ç¾¤
- **è¯·æ±‚å‚æ•°**:
```typescript
interface AddNodeRequest {
  join_ip: string;              // èŠ‚ç‚¹IP
  join_hostname: string;        // èŠ‚ç‚¹ä¸»æœºå
}
```

#### ç§»é™¤èŠ‚ç‚¹
- **URL**: `POST /cluster/remove`
- **ç”¨é€”**: ä»é›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹
- **è¯·æ±‚å‚æ•°**: `{ hostname: string }`

#### è§£æ•£é›†ç¾¤
- **URL**: `POST /cluster/dissolve`
- **ç”¨é€”**: è§£æ•£æ•´ä¸ªé›†ç¾¤
- **è¯·æ±‚å‚æ•°**: æ— 
- **å®‰å…¨æªæ–½**: éœ€è¦å®‰å…¨ç¡®è®¤æµç¨‹

---

## 3. ç›¸å…³ä¾èµ–æ¨¡å—

### 3.1 æœåŠ¡å±‚æ–‡ä»¶

#### é›†ç¾¤æœåŠ¡ (`src/services/cluster/index.ts`)
```typescript
import { clusterInitService } from "@/services/cluster";

// ä¸»è¦æ–¹æ³•ï¼š
- getClusterSummary()          // è·å–é›†ç¾¤æ¦‚è§ˆ
- getClusterNodes()            // è·å–é›†ç¾¤èŠ‚ç‚¹
- getClusterResources()        // è·å–é›†ç¾¤èµ„æº
- getNodeSummary(hostname)     // è·å–èŠ‚ç‚¹è¯¦æƒ…
- getNodePCIDevices(hostname)  // è·å–PCIè®¾å¤‡
- getNodeDiskDevices(hostname) // è·å–ç£ç›˜è®¾å¤‡
- addNode(nodeData)            // æ·»åŠ èŠ‚ç‚¹
- removeNode(nodeData)         // ç§»é™¤èŠ‚ç‚¹
- dissolveCluster()            // è§£æ•£é›†ç¾¤
- rebootNode(hostname)         // é‡å¯èŠ‚ç‚¹
- stopNode(hostname)           // å…³é—­èŠ‚ç‚¹
- enterMaintenanceMode(hostname) // è¿›å…¥ç»´æŠ¤æ¨¡å¼
- exitMaintenanceMode(hostname)  // é€€å‡ºç»´æŠ¤æ¨¡å¼
```

#### ç±»å‹å®šä¹‰ (`src/services/cluster/types.ts`)
```typescript
// å¯¼å‡ºçš„ä¸»è¦ç±»å‹ï¼š
- ClusterNodesResponse         // é›†ç¾¤èŠ‚ç‚¹å“åº”
- ClusterSummaryResponse       // é›†ç¾¤æ¦‚è§ˆå“åº”
- ClusterResourcesResponse     // é›†ç¾¤èµ„æºå“åº”
- NodeSummaryResponse          // èŠ‚ç‚¹è¯¦æƒ…å“åº”
- NodePCIResponse             // PCIè®¾å¤‡å“åº”
- NodeDisksResponse           // ç£ç›˜è®¾å¤‡å“åº”
- AddNodeRequest/Response     // æ·»åŠ èŠ‚ç‚¹è¯·æ±‚/å“åº”
- RemoveNodeRequest/Response  // ç§»é™¤èŠ‚ç‚¹è¯·æ±‚/å“åº”
```

### 3.2 è‡ªå®šä¹‰Hooks

#### ä¾§è¾¹æ é€‰æ‹©ç®¡ç† (`src/hooks/useSidebarSelection.ts`)
```typescript
const {
  selectedHost: sidebarSelectedHost,
  selectedVM: sidebarSelectedVM,
} = useSidebarSelection();

// åŠŸèƒ½ï¼š
- ç»Ÿä¸€ç®¡ç†ä¾§è¾¹æ é€‰æ‹©çŠ¶æ€
- è‡ªåŠ¨å¤„ç† hierarchical-sidebar-select äº‹ä»¶
- æä¾›ç±»å‹å®‰å…¨çš„çŠ¶æ€è®¿é—®
- ç»Ÿä¸€çš„çŠ¶æ€æ¸…ç†æ¥å£
```

#### ä¾§è¾¹æ åˆ·æ–°ç®¡ç† (`src/hooks/useSidebarRefresh.ts`)
```typescript
useSidebarRefresh((detail) => {
  if (detail.type === "cluster") {
    fetchRealClusterData();
  }
});

// åŠŸèƒ½ï¼š
- ç›‘å¬ä¾§è¾¹æ åˆ·æ–°äº‹ä»¶
- æ”¯æŒæ¡ä»¶è¿‡æ»¤
- è‡ªåŠ¨æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
```

#### ä¸»æœºæ“ä½œç®¡ç† (`src/hooks/useSidebarHostActions.ts`)
```typescript
useSidebarHostActions((operation, hostname, hostData) => {
  handleNodeOperation(operation, hostname);
});

// åŠŸèƒ½ï¼š
- å¤„ç†ä¾§è¾¹æ ä¸»æœºæ“ä½œäº‹ä»¶
- æ“ä½œç±»å‹æ ‡å‡†åŒ–æ˜ å°„
- ç±»å‹å®‰å…¨çš„å›è°ƒæ¥å£
```

### 3.3 å·¥å…·å‡½æ•°

#### æ ¼å¼åŒ–å·¥å…· (`src/utils/format.ts`)
```typescript
import {
  formatResourceUsage,    // æ ¼å¼åŒ–èµ„æºä½¿ç”¨æƒ…å†µ
  formatUptime,          // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
  formatNetworkThroughput, // æ ¼å¼åŒ–ç½‘ç»œååé‡
  formatLoadAverage,     // æ ¼å¼åŒ–è´Ÿè½½å¹³å‡å€¼
  formatPowerState,      // æ ¼å¼åŒ–ç”µæºçŠ¶æ€
} from "../../utils/format";

// ä½¿ç”¨ç¤ºä¾‹ï¼š
const cpuUsage = formatResourceUsage(used, total, "æ ¸");
const uptime = formatUptime(seconds);
const powerState = formatPowerState(state);
```

#### APIåŠ©æ‰‹ (`src/utils/apiHelper.ts`)
```typescript
import { api } from '@/utils/apiHelper';

// ç»Ÿä¸€çš„APIè°ƒç”¨æ¥å£ï¼š
- è‡ªåŠ¨é”™è¯¯å¤„ç†
- ç»Ÿä¸€å“åº”æ ¼å¼
- Mockæ•°æ®æ”¯æŒ
- è¯·æ±‚æ‹¦æˆªå’Œå“åº”æ‹¦æˆª
```

### 3.4 UIç»„ä»¶ä¾èµ–

#### æ€§èƒ½å›¾è¡¨ç»„ä»¶ (`src/components/ClusterComponent`)
```typescript
import {
  CpuPerformanceChart,     // CPUæ€§èƒ½å›¾è¡¨
  MemoryPerformanceChart,  // å†…å­˜æ€§èƒ½å›¾è¡¨
  DiskPerformanceChart,    // ç£ç›˜æ€§èƒ½å›¾è¡¨
  NetworkPerformanceChart, // ç½‘ç»œæ€§èƒ½å›¾è¡¨
} from "@/components/ClusterComponent";
```

#### ç£ç›˜è®¾å¤‡æ ‘è¡¨ç»„ä»¶
```typescript
import DiskDeviceTreeTable from "@/components/DiskDeviceTreeTable";
// ç”¨äºæ˜¾ç¤ºç£ç›˜è®¾å¤‡çš„å±‚çº§ç»“æ„
```

#### å®‰å…¨ç¡®è®¤æ¨¡æ€æ¡†
```typescript
import SafetyConfirmModal from "@/components/SafetyConfirmModal";
// ç”¨äºå±é™©æ“ä½œçš„å®‰å…¨ç¡®è®¤
```

---

## 4. æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†

### 4.1 çŠ¶æ€ç®¡ç†æ¶æ„

é›†ç¾¤ç®¡ç†æ¨¡å—é‡‡ç”¨ **æœ¬åœ°çŠ¶æ€ç®¡ç†** æ¨¡å¼ï¼Œä¸»è¦ä½¿ç”¨ React Hooks è¿›è¡ŒçŠ¶æ€ç®¡ç†ï¼š

#### ä¸»è¦çŠ¶æ€åˆ†ç±»
```typescript
// 1. æ•°æ®çŠ¶æ€
const [realClusterData, setRealClusterData] = useState<ClusterNodesResponse | null>(null);
const [clusterSummaryData, setClusterSummaryData] = useState<ClusterSummaryResponse | null>(null);
const [clusterResourcesData, setClusterResourcesData] = useState<ClusterResourcesResponse | null>(null);
const [nodeDetailData, setNodeDetailData] = useState<NodeSummaryResponse | null>(null);

// 2. åŠ è½½çŠ¶æ€
const [realClusterLoading, setRealClusterLoading] = useState(false);
const [clusterSummaryLoading, setClusterSummaryLoading] = useState(false);
const [nodeDetailLoading, setNodeDetailLoading] = useState(false);

// 3. é”™è¯¯çŠ¶æ€
const [realClusterError, setRealClusterError] = useState<string | null>(null);
const [clusterSummaryError, setClusterSummaryError] = useState<string | null>(null);

// 4. UIçŠ¶æ€
const [activeTab, setActiveTab] = useState("overview");
const [hostDetailActiveTab, setHostDetailActiveTab] = useState("basic");
const [addNodeModalVisible, setAddNodeModalVisible] = useState(false);

// 5. æ“ä½œçŠ¶æ€
const [nodeOperationLoading, setNodeOperationLoading] = useState<string | null>(null);
const [safetyConfirmVisible, setSafetyConfirmVisible] = useState(false);
```

### 4.2 æ•°æ®è·å–å’Œæ›´æ–°æœºåˆ¶

#### æ‡’åŠ è½½ç­–ç•¥
```typescript
// æŒ‰éœ€åŠ è½½æ•°æ®çš„å®ç°
const loadTabData = useCallback(async (tab: string, force = false) => {
  // é˜²æ­¢é‡å¤è°ƒç”¨æ£€æŸ¥
  if (!force && loadingRef.current.has(tab)) {
    return;
  }

  loadingRef.current.add(tab);

  try {
    switch (tab) {
      case "overview":
        await fetchClusterSummaryData();
        break;
      case "list":
        await fetchRealClusterData();
        break;
      case "resources":
        await fetchClusterResourcesData();
        break;
    }
  } finally {
    loadingRef.current.delete(tab);
  }
}, [fetchClusterSummaryData, fetchRealClusterData, fetchClusterResourcesData]);
```

#### APIé˜²é‡å¤è°ƒç”¨æœºåˆ¶
```typescript
// å…¨å±€APIé”æœºåˆ¶
const globalApiLockRef = useRef<Set<string>>(new Set());

const withApiLock = useCallback(<T extends unknown[]>(
  apiName: string,
  apiFunc: (...args: T) => Promise<void>
) => {
  return async (...args: T) => {
    if (globalApiLockRef.current.has(apiName)) {
      console.log(`â›” API ${apiName} æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨`);
      return;
    }

    globalApiLockRef.current.add(apiName);
    try {
      await apiFunc(...args);
    } finally {
      globalApiLockRef.current.delete(apiName);
    }
  };
}, []);

// ä½¿ç”¨APIé”åŒ…è£…çš„å‡½æ•°
const fetchRealClusterData = useMemo(
  () => withApiLock("fetchRealClusterData", fetchRealClusterDataBase),
  [withApiLock, fetchRealClusterDataBase]
);
```

### 4.3 æ•°æ®ç¼“å­˜å’Œåˆ·æ–°ç­–ç•¥

#### æ ‡ç­¾é¡µåˆ‡æ¢ç¼“å­˜
```typescript
// é˜²é‡å¤è°ƒç”¨çš„æ ‡è®°å’ŒTabè¿½è¸ª
const loadingRef = useRef<Set<string>>(new Set());
const lastActiveTabRef = useRef<string | null>(null);
const tabChangeTimerRef = useRef<NodeJS.Timeout | null>(null);

// ä½¿ç”¨é˜²æŠ–ç­–ç•¥é¿å…å¿«é€Ÿåˆ‡æ¢æ—¶çš„é‡å¤è°ƒç”¨
useEffect(() => {
  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (tabChangeTimerRef.current) {
    clearTimeout(tabChangeTimerRef.current);
  }

  // å¦‚æœTabæ²¡æœ‰å®é™…å˜åŒ–ï¼Œè·³è¿‡
  if (isInitialized && lastActiveTabRef.current === activeTab) {
    return;
  }

  // ä½¿ç”¨é˜²æŠ–å»¶è¿Ÿæ‰§è¡Œ
  tabChangeTimerRef.current = setTimeout(() => {
    loadTabData(activeTab);
  }, isInitialized ? 50 : 100);

  return () => {
    if (tabChangeTimerRef.current) {
      clearTimeout(tabChangeTimerRef.current);
    }
  };
}, [activeTab, isInitialized, loadTabData]);
```

#### ç¡¬ä»¶ä¿¡æ¯æŒ‰éœ€åŠ è½½
```typescript
// å½“åˆ‡æ¢åˆ°hardware Tabæ—¶ï¼ŒæŒ‰éœ€åŠ è½½ç¡¬ä»¶ä¿¡æ¯
if (key === "hardware" && sidebarSelectedHost) {
  // å¦‚æœè¿˜æ²¡æœ‰PCIè®¾å¤‡æ•°æ®ï¼Œåˆ™åŠ è½½
  if (!nodePCIData) {
    fetchNodePCIData(sidebarSelectedHost.name);
  }

  // å¦‚æœè¿˜æ²¡æœ‰ç£ç›˜è®¾å¤‡æ•°æ®ï¼Œåˆ™åŠ è½½
  if (!nodeDisksData) {
    fetchNodeDisksData(sidebarSelectedHost.name);
  }
}
```

### 4.4 äº‹ä»¶é©±åŠ¨çš„æ•°æ®åŒæ­¥

#### ä¾§è¾¹æ äº‹ä»¶ç›‘å¬
```typescript
// ä¾§è¾¹æ åˆ·æ–°äº‹ä»¶å¤„ç†
useSidebarRefresh((detail) => {
  if (detail.type === "cluster") {
    fetchRealClusterData();
  }
});

// ä¾§è¾¹æ ä¸»æœºæ“ä½œäº‹ä»¶å¤„ç†
useSidebarHostActions((operation, hostname, hostData) => {
  const validOperations = ["reboot", "stop", "enter_maintenance", "exit_maintenance", "migrate"];
  if (validOperations.includes(operation)) {
    handleNodeOperation(operation, hostname);
  }
});
```

#### æ“ä½œåæ•°æ®åˆ·æ–°
```typescript
// æ“ä½œæˆåŠŸåè§¦å‘åˆ·æ–°äº‹ä»¶
if (result.success) {
  message.success(result.message);
  // åˆ·æ–°ç‰©ç†æœºåˆ—è¡¨
  fetchRealClusterData();

  // è§¦å‘ä¾§è¾¹æ åˆ·æ–°äº‹ä»¶
  SidebarRefreshTriggers.cluster("node-added");
}
```

---

## 5. æŠ€æœ¯å®ç°ç»†èŠ‚

### 5.1 ç»„ä»¶æ¸²æŸ“é€»è¾‘

é›†ç¾¤ç®¡ç†æ¨¡å—é‡‡ç”¨ **æ¡ä»¶æ¸²æŸ“** æ¨¡å¼ï¼Œæ ¹æ®ä¾§è¾¹æ é€‰æ‹©çŠ¶æ€å†³å®šæ˜¾ç¤ºå†…å®¹ï¼š

```typescript
const ClusterManagement: React.FC = () => {
  const {
    selectedHost: sidebarSelectedHost,
    selectedVM: sidebarSelectedVM,
  } = useSidebarSelection();

  // å¦‚æœé€‰æ‹©äº†ä¸»æœºï¼Œæ˜¾ç¤ºä¸»æœºè¯¦æƒ…é¡µé¢
  if (sidebarSelectedHost) {
    return <HostDetailPage />;
  }

  // å¦‚æœé€‰æ‹©äº†è™šæ‹Ÿæœºï¼Œæ˜¾ç¤ºè™šæ‹Ÿæœºè¯¦æƒ…é¡µé¢
  if (sidebarSelectedVM) {
    return <VMDetailPage />;
  }

  // é»˜è®¤æ˜¾ç¤ºé›†ç¾¤ç®¡ç†ä¸»é¡µé¢
  return <ClusterMainPage />;
};
```

### 5.2 çŠ¶æ€æ ‡ç­¾æ¸²æŸ“ç³»ç»Ÿ

```typescript
// ç»Ÿä¸€çš„çŠ¶æ€æ ‡ç­¾æ¸²æŸ“å‡½æ•°
const getStatusTag = (status: string) => {
  switch (status) {
    case "running":
      return <Tag icon={<CheckCircleOutlined />} color="success">è¿è¡Œä¸­</Tag>;
    case "healthy":
      return <Tag icon={<CheckCircleOutlined />} color="success">å¥åº·</Tag>;
    case "warning":
      return <Tag icon={<ExclamationCircleOutlined />} color="warning">è­¦å‘Š</Tag>;
    case "maintenance":
      return <Tag icon={<SyncOutlined spin />} color="processing">ç»´æŠ¤ä¸­</Tag>;
    case "error":
      return <Tag icon={<WarningOutlined />} color="error">é”™è¯¯</Tag>;
    case "online":
      return <Tag color="success">åœ¨çº¿</Tag>;
    case "offline":
      return <Tag color="error">ç¦»çº¿</Tag>;
    default:
      return <Tag color="default">{status}</Tag>;
  }
};
```

### 5.3 è¡¨æ ¼åˆ—å®šä¹‰ç³»ç»Ÿ

#### ç‰©ç†æœºèŠ‚ç‚¹è¡¨æ ¼åˆ—
```typescript
const realClusterNodesColumns = [
  {
    title: "èŠ‚ç‚¹åç§°",
    dataIndex: "name",
    key: "name",
    render: (name: string, record: ClusterNode) => (
      <div>
        <div style={{ fontWeight: "bold" }}>
          {name}
          {record.is_dc && <Tag color="purple" style={{ marginLeft: "8px" }}>DC</Tag>}
        </div>
        <div style={{ fontSize: "12px", color: "#666" }}>ID: {record.node_id}</div>
      </div>
    ),
  },
  {
    title: "IPåœ°å€",
    dataIndex: "ip",
    key: "ip",
    render: (ip: string) => <Tag color="blue">{ip}</Tag>,
  },
  {
    title: "çŠ¶æ€",
    dataIndex: "status",
    key: "status",
    render: (status: string) => getStatusTag(status),
  },
  {
    title: "èµ„æºä½¿ç”¨",
    key: "resources",
    render: (_, record: ClusterNode) => {
      const cpuUsage = formatResourceUsage(record.cpu_used, record.cpu_total, "æ ¸");
      const memUsage = formatResourceUsage(record.mem_used, record.mem_total, "GB");

      return (
        <div style={{ fontSize: "12px" }}>
          <div>CPU: <span style={{ color: getProgressColor(cpuUsage.percentage) }}>{cpuUsage.display}</span></div>
          <div>å†…å­˜: <span style={{ color: getProgressColor(memUsage.percentage) }}>{memUsage.display}</span></div>
        </div>
      );
    },
  },
  // ... æ›´å¤šåˆ—å®šä¹‰
];
```

### 5.4 ä¸»æœºæ“ä½œå¤„ç†ç³»ç»Ÿ

```typescript
const handleNodeOperation = useCallback(async (
  operation: "reboot" | "stop" | "enter_maintenance" | "exit_maintenance" | "migrate",
  hostname: string
) => {
  const operationNames = {
    reboot: "é‡å¯",
    stop: "å…³æœº",
    enter_maintenance: "è¿›å…¥ç»´æŠ¤æ¨¡å¼",
    exit_maintenance: "é€€å‡ºç»´æŠ¤æ¨¡å¼",
    migrate: "è¿ç§»è™šæ‹Ÿæœº",
  };

  try {
    // ç‰¹æ®Šå¤„ç†ï¼šè¿›å…¥ç»´æŠ¤æ¨¡å¼å‰æ£€æŸ¥è™šæ‹ŸæœºçŠ¶æ€
    if (operation === "enter_maintenance") {
      const canEnter = checkCanEnterMaintenance(hostname);
      if (!canEnter) {
        modal.warning({
          title: "æ— æ³•è¿›å…¥ç»´æŠ¤æ¨¡å¼",
          content: "è¯¥èŠ‚ç‚¹ä¸Šè¿˜æœ‰è¿è¡Œä¸­çš„è™šæ‹Ÿæœºï¼Œè¯·å…ˆå…³é—­æˆ–è¿ç§»è™šæ‹Ÿæœºåå†è¿›å…¥ç»´æŠ¤æ¨¡å¼ã€‚",
        });
        return;
      }
    }

    modal.confirm({
      title: `ç¡®è®¤${operationNames[operation]}`,
      content: `æ‚¨ç¡®å®šè¦å¯¹èŠ‚ç‚¹ ${hostname} æ‰§è¡Œ${operationNames[operation]}æ“ä½œå—ï¼Ÿ`,
      onOk: async () => {
        setNodeOperationLoading(operation);

        let result;
        switch (operation) {
          case "reboot":
            result = await clusterInitService.rebootNode(hostname);
            break;
          case "stop":
            result = await clusterInitService.stopNode(hostname);
            break;
          case "enter_maintenance":
            result = await clusterInitService.enterMaintenanceMode(hostname);
            break;
          case "exit_maintenance":
            result = await clusterInitService.exitMaintenanceMode(hostname);
            break;
          default:
            return;
        }

        if (result.success) {
          message.success(result.message);
          // æ“ä½œæˆåŠŸååˆ·æ–°èŠ‚ç‚¹è¯¦æƒ…
          setTimeout(() => {
            fetchNodeDetailData(hostname);
          }, 2000);
        } else {
          modal.error({
            title: `${operationNames[operation]}å¤±è´¥`,
            content: result.message,
          });
        }

        setNodeOperationLoading(null);
      },
    });
  } catch (error) {
    console.error(`Error in handleNodeOperation:`, error);
    setNodeOperationLoading(null);
  }
}, [checkCanEnterMaintenance, fetchNodeDetailData, modal, message]);
```

### 5.5 å®‰å…¨ç¡®è®¤æµç¨‹

```typescript
// å®‰å…¨ç¡®è®¤æ¨¡æ€æ¡†é…ç½®
const getSafetyConfirmProps = useCallback(() => {
  if (!pendingAction) return null;

  switch (pendingAction.type) {
    case "removeNode":
      return {
        title: "ç¡®è®¤ç§»é™¤èŠ‚ç‚¹",
        description: `æ‚¨å³å°†ä»é›†ç¾¤ä¸­ç§»é™¤èŠ‚ç‚¹ "${pendingAction.data.nodeName}"ã€‚æ­¤æ“ä½œå°†ä¼šå½±å“é›†ç¾¤çš„å¯ç”¨æ€§ï¼Œè¯·ç¡®ä¿è¯¥èŠ‚ç‚¹ä¸Šæ²¡æœ‰é‡è¦çš„è¿è¡Œä¸­è™šæ‹Ÿæœºã€‚`,
        confirmText: `remove ${pendingAction.data.nodeName}`,
        warning: "ç§»é™¤èŠ‚ç‚¹æ˜¯ä¸å¯é€†æ“ä½œï¼Œç§»é™¤åèŠ‚ç‚¹ä¸Šçš„æ•°æ®å°†æ— æ³•æ¢å¤ã€‚è¯·ç¡®ä¿å·²å¤‡ä»½é‡è¦æ•°æ®ã€‚",
        confirmButtonText: "ç§»é™¤èŠ‚ç‚¹",
      };
    case "dissolveCluster":
      return {
        title: "ç¡®è®¤è§£æ•£é›†ç¾¤",
        description: "æ‚¨å³å°†è§£æ•£å½“å‰é›†ç¾¤ã€‚æ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰é›†ç¾¤é…ç½®å’Œæ•°æ®ã€‚",
        confirmText: "dissolve cluster",
        warning: "è§£æ•£é›†ç¾¤æ˜¯æå…¶å±é™©çš„æ“ä½œï¼Œæ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ä¸”æ— æ³•æ¢å¤ã€‚è¯·ç¡®ä¿å·²å¤‡ä»½æ‰€æœ‰é‡è¦æ•°æ®ã€‚",
        confirmButtonText: "è§£æ•£é›†ç¾¤",
      };
    default:
      return null;
  }
}, [pendingAction]);

// å®‰å…¨ç¡®è®¤å¤„ç†å‡½æ•°
const handleSafetyConfirm = useCallback(() => {
  if (!pendingAction) return;

  switch (pendingAction.type) {
    case "removeNode":
      if (pendingAction.data.hostname && pendingAction.data.nodeName) {
        executeRemoveNode(pendingAction.data.hostname, pendingAction.data.nodeName);
      }
      break;
    case "dissolveCluster":
      executeDissolveCluster();
      break;
    default:
      setSafetyConfirmVisible(false);
      setPendingAction(null);
  }
}, [pendingAction, executeRemoveNode, executeDissolveCluster]);
```

---

## 6. æ€§èƒ½ä¼˜åŒ–æªæ–½

### 6.1 æ‡’åŠ è½½å’ŒæŒ‰éœ€åŠ è½½

#### æ ‡ç­¾é¡µæ‡’åŠ è½½
```typescript
// åªæœ‰åœ¨ç”¨æˆ·åˆ‡æ¢åˆ°ç‰¹å®šæ ‡ç­¾æ—¶æ‰è°ƒç”¨API
const [loadedTabs, setLoadedTabs] = useState(new Set(['overview']));

const handleTabChange = (key: string) => {
  setActiveTab(key);
  if (!loadedTabs.has(key)) {
    // é¦–æ¬¡è®¿é—®è¯¥æ ‡ç­¾ï¼ŒåŠ è½½æ•°æ®
    loadTabData(key);
    setLoadedTabs(prev => new Set([...prev, key]));
  }
};
```

#### ç¡¬ä»¶ä¿¡æ¯æŒ‰éœ€åŠ è½½
```typescript
// å½“åˆ‡æ¢åˆ°hardware Tabæ—¶ï¼ŒæŒ‰éœ€åŠ è½½ç¡¬ä»¶ä¿¡æ¯
if (key === "hardware" && sidebarSelectedHost) {
  // å¦‚æœè¿˜æ²¡æœ‰PCIè®¾å¤‡æ•°æ®ï¼Œåˆ™åŠ è½½
  if (!nodePCIData) {
    fetchNodePCIData(sidebarSelectedHost.name);
  }

  // å¦‚æœè¿˜æ²¡æœ‰ç£ç›˜è®¾å¤‡æ•°æ®ï¼Œåˆ™åŠ è½½
  if (!nodeDisksData) {
    fetchNodeDisksData(sidebarSelectedHost.name);
  }
}
```

### 6.2 é˜²æŠ–å’ŒèŠ‚æµä¼˜åŒ–

#### Tabåˆ‡æ¢é˜²æŠ–
```typescript
// ä½¿ç”¨é˜²æŠ–ç­–ç•¥é¿å…å¿«é€Ÿåˆ‡æ¢æ—¶çš„é‡å¤è°ƒç”¨
tabChangeTimerRef.current = setTimeout(() => {
  if (!isInitialized) {
    setIsInitialized(true);
  }
  loadTabData(activeTab);
}, isInitialized ? 50 : 100); // åˆå§‹åŒ–æ—¶å»¶è¿Ÿæ›´é•¿
```

#### APIè°ƒç”¨é˜²é‡å¤
```typescript
// å…¨å±€APIé˜²é‡å¤è°ƒç”¨æœºåˆ¶
const globalApiLockRef = useRef<Set<string>>(new Set());

const withApiLock = useCallback(<T extends unknown[]>(
  apiName: string,
  apiFunc: (...args: T) => Promise<void>
) => {
  return async (...args: T) => {
    if (globalApiLockRef.current.has(apiName)) {
      console.log(`â›” API ${apiName} æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨`);
      return;
    }

    globalApiLockRef.current.add(apiName);
    try {
      await apiFunc(...args);
    } finally {
      globalApiLockRef.current.delete(apiName);
    }
  };
}, []);
```

### 6.3 å†…å­˜ä¼˜åŒ–

#### ç»„ä»¶å¸è½½æ—¶æ¸…ç†
```typescript
useEffect(() => {
  return () => {
    // æ¸…ç†å®šæ—¶å™¨
    if (tabChangeTimerRef.current) {
      clearTimeout(tabChangeTimerRef.current);
    }

    // æ¸…ç†APIé”
    globalApiLockRef.current.clear();
  };
}, []);
```

#### å¤§æ•°æ®é‡è¡¨æ ¼ä¼˜åŒ–
```typescript
// è¡¨æ ¼åˆ†é¡µé…ç½®
pagination={{
  pageSize: 10,
  showSizeChanger: true,
  showQuickJumper: true,
  showTotal: (total, range) => `ç¬¬ ${range[0]}-${range[1]} æ¡/å…± ${total} æ¡`,
}}

// è¡¨æ ¼æ»šåŠ¨é…ç½®
scroll={{ x: 800 }}
```

### 6.4 æ¸²æŸ“ä¼˜åŒ–

#### æ¡ä»¶æ¸²æŸ“ä¼˜åŒ–
```typescript
// ä½¿ç”¨æ¡ä»¶æ¸²æŸ“é¿å…ä¸å¿…è¦çš„ç»„ä»¶åˆ›å»º
if (sidebarSelectedHost) {
  return <HostDetailPage />;
}

if (sidebarSelectedVM) {
  return <VMDetailPage />;
}

return <ClusterMainPage />;
```

#### çŠ¶æ€æ›´æ–°ä¼˜åŒ–
```typescript
// æ‰¹é‡çŠ¶æ€æ›´æ–°
const updateNodeDetailState = useCallback((data: NodeSummaryResponse) => {
  setNodeDetailData(data);
  setNodeDetailError(null);
  setNodeDetailLoading(false);
}, []);
```

---

## 7. é”™è¯¯å¤„ç†æœºåˆ¶

### 7.1 APIé”™è¯¯å¤„ç†

#### ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼
```typescript
const fetchClusterSummaryDataBase = useCallback(async () => {
  const timestamp = new Date().toLocaleTimeString();
  setClusterSummaryLoading(true);
  setClusterSummaryError(null);

  try {
    console.log(`ğŸ“¡ [${timestamp}][API Call] å¼€å§‹è°ƒç”¨é›†ç¾¤æ¦‚è§ˆAPI`);
    const result = await clusterInitService.getClusterSummary();

    if (result.success && result.data) {
      setClusterSummaryData(result.data);
      console.log(`âœ… [${timestamp}][API Success] è·å–é›†ç¾¤æ¦‚è§ˆæ•°æ®æˆåŠŸ`);
    } else {
      console.error(`âŒ [${timestamp}][API Error] è·å–é›†ç¾¤æ¦‚è§ˆæ•°æ®å¤±è´¥:`, result.message);
      setClusterSummaryError(result.message);
      message.error(result.message);
    }
  } catch (error) {
    console.error(`âŒ [${timestamp}][API Exception] è·å–é›†ç¾¤æ¦‚è§ˆæ•°æ®å¼‚å¸¸:`, error);
    const errorMessage = "è·å–é›†ç¾¤æ¦‚è§ˆæ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
    setClusterSummaryError(errorMessage);
    message.error(errorMessage);
  } finally {
    setClusterSummaryLoading(false);
    console.log(`ğŸ [${timestamp}][API Complete] é›†ç¾¤æ¦‚è§ˆAPIè°ƒç”¨å®Œæˆ`);
  }
}, [message]);
```

#### é”™è¯¯çŠ¶æ€æ˜¾ç¤º
```typescript
// é”™è¯¯çŠ¶æ€çš„UIå±•ç¤º
{clusterSummaryError ? (
  <div style={{ textAlign: "center", padding: "50px" }}>
    <Alert
      message="è·å–é›†ç¾¤æ¦‚è§ˆæ•°æ®å¤±è´¥"
      description={clusterSummaryError}
      type="error"
      showIcon
      action={
        <Button
          type="primary"
          onClick={fetchClusterSummaryData}
          icon={<SyncOutlined />}
        >
          é‡æ–°åŠ è½½
        </Button>
      }
    />
  </div>
) : (
  // æ­£å¸¸å†…å®¹
)}
```

### 7.2 æ“ä½œé”™è¯¯å¤„ç†

#### ä¸»æœºæ“ä½œé”™è¯¯å¤„ç†
```typescript
try {
  // åœ¨ç”¨æˆ·ç¡®è®¤åæ‰è®¾ç½®loadingçŠ¶æ€
  setNodeOperationLoading(operation);

  let result;
  switch (operation) {
    case "reboot":
      result = await clusterInitService.rebootNode(hostname);
      break;
    // ... å…¶ä»–æ“ä½œ
  }

  if (result.success) {
    message.success(result.message || `${operationNames[operation]}æ“ä½œæˆåŠŸ`);
    // æ“ä½œæˆåŠŸååˆ·æ–°èŠ‚ç‚¹è¯¦æƒ…
    setTimeout(() => {
      fetchNodeDetailData(hostname);
    }, 2000);
  } else {
    modal.error({
      title: `${operationNames[operation]}å¤±è´¥`,
      content: result.message || `${operationNames[operation]}æ“ä½œå¤±è´¥`,
    });
  }
} catch (error) {
  console.error(`${operation} operation failed:`, error);
  modal.error({
    title: "æ“ä½œå¤±è´¥",
    content: `${operationNames[operation]}æ“ä½œæ‰§è¡Œå¤±è´¥`,
  });
} finally {
  setNodeOperationLoading(null);
}
```

### 7.3 ç½‘ç»œé”™è¯¯å¤„ç†

#### ç½‘ç»œè¿æ¥æ£€æŸ¥
```typescript
// åœ¨APIè°ƒç”¨å¤±è´¥æ—¶æä¾›ç½‘ç»œè¿æ¥æç¤º
catch (error) {
  console.error(`âŒ [${timestamp}][API Exception] è·å–æ•°æ®å¼‚å¸¸:`, error);

  let errorMessage = "è·å–æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";

  // æ£€æŸ¥æ˜¯å¦ä¸ºç½‘ç»œé”™è¯¯
  if (error.message.includes('Network Error') || error.message.includes('fetch')) {
    errorMessage = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•";
  }

  setError(errorMessage);
  message.error(errorMessage);
}
```

### 7.4 ç”¨æˆ·è¾“å…¥éªŒè¯

#### è¡¨å•éªŒè¯
```typescript
// æ·»åŠ èŠ‚ç‚¹è¡¨å•éªŒè¯
<Form.Item
  label="èŠ‚ç‚¹IPåœ°å€"
  name="join_ip"
  rules={[
    { required: true, message: "è¯·è¾“å…¥èŠ‚ç‚¹IPåœ°å€" },
    {
      pattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
      message: "è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€æ ¼å¼"
    }
  ]}
>
  <Input placeholder="ä¾‹å¦‚: 192.168.1.100" />
</Form.Item>

<Form.Item
  label="èŠ‚ç‚¹ä¸»æœºå"
  name="join_hostname"
  rules={[
    { required: true, message: "è¯·è¾“å…¥èŠ‚ç‚¹ä¸»æœºå" },
    {
      pattern: /^[a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?$/,
      message: "ä¸»æœºåæ ¼å¼ä¸æ­£ç¡®"
    }
  ]}
>
  <Input placeholder="ä¾‹å¦‚: node-02" />
</Form.Item>
```

### 7.5 è¾¹ç•Œæƒ…å†µå¤„ç†

#### ç©ºæ•°æ®å¤„ç†
```typescript
// ç©ºæ•°æ®çŠ¶æ€å±•ç¤º
{realClusterData && realClusterData.nodes.length > 0 ? (
  <Table
    columns={realClusterNodesColumns}
    dataSource={realClusterData.nodes}
    // ... å…¶ä»–é…ç½®
  />
) : (
  <div style={{ textAlign: "center", padding: "50px" }}>
    <Alert
      message="æš‚æ— ç‰©ç†æœºæ•°æ®"
      description="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·å–æœ€æ–°çš„ç‰©ç†æœºèŠ‚ç‚¹ä¿¡æ¯"
      type="info"
      showIcon
      action={
        <Button
          type="primary"
          onClick={fetchRealClusterData}
          icon={<SyncOutlined />}
        >
          è·å–æ•°æ®
        </Button>
      }
    />
  </div>
)}
```

#### æƒé™æ£€æŸ¥
```typescript
// æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯ä»¥è¿›å…¥ç»´æŠ¤æ¨¡å¼
const checkCanEnterMaintenance = useCallback((hostname: string): boolean => {
  try {
    // ä½¿ç”¨èŠ‚ç‚¹æ‘˜è¦æ•°æ®æ¥æ£€æŸ¥ï¼Œé¿å…è°ƒç”¨ä¸å­˜åœ¨çš„checkNodeStatusæ¥å£
    if (nodeDetailData && nodeDetailData.node_name === hostname) {
      return nodeDetailData.running_vm_num === 0;
    }

    // å¦‚æœæ²¡æœ‰èŠ‚ç‚¹è¯¦æƒ…æ•°æ®ï¼Œåˆ™ç›´æ¥å…è®¸è¿›å…¥ç»´æŠ¤æ¨¡å¼
    // åç«¯ä¼šåœ¨å®é™…æ“ä½œæ—¶è¿›è¡Œæ£€æŸ¥
    console.warn(`æ²¡æœ‰æ‰¾åˆ°èŠ‚ç‚¹ ${hostname} çš„è¯¦æƒ…æ•°æ®ï¼Œå…è®¸å°è¯•è¿›å…¥ç»´æŠ¤æ¨¡å¼`);
    return true;
  } catch (error) {
    console.error("æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€å¤±è´¥:", error);
    // å‡ºé”™æ—¶ä¹Ÿå…è®¸å°è¯•ï¼Œè®©åç«¯æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›å…¥ç»´æŠ¤æ¨¡å¼
    return true;
  }
}, [nodeDetailData]);
```

---

## 8. æ€»ç»“

### 8.1 æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„ç»„ä»¶åˆ†ç¦»å’ŒèŒè´£åˆ’åˆ†
2. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
3. **æ€§èƒ½ä¼˜åŒ–**: æ‡’åŠ è½½ã€é˜²æŠ–ã€APIé”ç­‰ä¼˜åŒ–æªæ–½
4. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆæœºåˆ¶
5. **å¯ç»´æŠ¤æ€§**: ç»Ÿä¸€çš„ä»£ç é£æ ¼å’Œæ³¨é‡Šè§„èŒƒ

### 8.2 æŠ€æœ¯ç‰¹è‰²

1. **Hookæ¶æ„**: ä½¿ç”¨è‡ªå®šä¹‰Hookç®€åŒ–çŠ¶æ€ç®¡ç†
2. **äº‹ä»¶é©±åŠ¨**: åŸºäºäº‹ä»¶çš„ç»„ä»¶é—´é€šä¿¡
3. **æ¡ä»¶æ¸²æŸ“**: æ ¹æ®çŠ¶æ€åŠ¨æ€åˆ‡æ¢é¡µé¢å†…å®¹
4. **å®‰å…¨æœºåˆ¶**: å±é™©æ“ä½œçš„å®‰å…¨ç¡®è®¤æµç¨‹

### 8.3 æ‰©å±•å»ºè®®

1. **è™šæ‹ŸåŒ–ä¼˜åŒ–**: å¯¹äºå¤§æ•°æ®é‡è¡¨æ ¼å¯è€ƒè™‘è™šæ‹Ÿæ»šåŠ¨
2. **ç¼“å­˜ç­–ç•¥**: å¯ä»¥æ·»åŠ æ›´æ™ºèƒ½çš„æ•°æ®ç¼“å­˜æœºåˆ¶
3. **å®æ—¶æ›´æ–°**: å¯ä»¥è€ƒè™‘WebSocketå®æ—¶æ•°æ®æ›´æ–°
4. **å›½é™…åŒ–**: æ”¯æŒå¤šè¯­è¨€ç•Œé¢

---

*æœ¬æ–‡æ¡£åŸºäº KR-virt é¡¹ç›® v0.0.0 ç‰ˆæœ¬ç¼–å†™ï¼Œæœ€åæ›´æ–°æ—¶é—´ï¼š2025å¹´6æœˆ24*
```
```