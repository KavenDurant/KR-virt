# 首次登录TOTP设置流程测试指南

## 功能概述
实现了一个完整的首次登录流程，包括：
1. 用户首次登录检测
2. 强制密码修改
3. TOTP双因子认证设置
4. 二维码生成和验证

## 测试账户
以下账户被配置为首次登录（`isFirstLogin: true`）：

| 用户名 | 密码 | 角色 | 权限 |
|--------|------|------|------|
| test | 123456 | administrator | 全部权限 |
| operator | Operator123!@# | operator | vm:read, vm:create, network:read |
| auditor | Auditor123!@# | auditor | audit:read, log:read |

已有用户（`isFirstLogin: false`）：
| 用户名 | 密码 | 角色 |
|--------|------|------|
| admin | Admin123!@# | administrator |

## 测试步骤

### 1. 测试首次登录流程
1. 访问 http://localhost:3001/
2. 使用测试账户登录（如 test/123456）
3. 系统会自动弹出"首次登录 - 修改密码"对话框

### 2. 测试密码修改
1. 在密码修改对话框中：
   - 输入新密码（建议：TestNew123!）
   - 确认新密码
   - 查看密码强度指示器
2. 点击"确认修改"
3. 系统显示"密码修改成功！接下来需要设置双因子认证"

### 3. 测试TOTP设置
1. 密码修改成功后，自动显示"设置双因子认证"对话框
2. **步骤1 - 扫描二维码**：
   - 查看步骤指示器显示"扫描二维码"
   - 查看真实的QR码图片（来自 `/public/QRCode.png`）
   - 查看手动输入密钥：`TA2SS5UUTTFSHBELVGVO53NRIR7AQHFM`
   - 点击"下一步"

3. **步骤2 - 验证码验证**：
   - 步骤指示器更新为"输入验证码"
   - 输入6位验证码（测试用：123456 或任意6位数字）
   - 点击"验证并完成设置"

### 4. 验证完成
1. 验证成功后显示："双因子认证设置完成！正在跳转到系统..."
2. 自动跳转到dashboard页面
3. 用户的`isFirstLogin`状态已更新为`false`

## 技术实现要点

### 状态管理
- `showChangePasswordModal`: 控制密码修改对话框
- `showTOTPModal`: 控制TOTP设置对话框
- `totpStep`: 控制TOTP设置步骤（0: 扫码, 1: 验证）
- `TOTP_SECRET`: 存储真实TOTP密钥常量

### 流程控制
1. 登录成功 → 检查`isFirstLogin`
2. 如果是首次登录 → 显示密码修改对话框
3. 密码修改成功 → 调用`setupTOTP()`
4. TOTP设置完成 → 跳转到dashboard

### TOTP功能
- **密钥**: 使用真实密钥 `TA2SS5UUTTFSHBELVGVO53NRIR7AQHFM`
- **二维码**: 使用真实QR码图片 `/public/QRCode.png`
- **验证**: 支持任意6位数字（演示用，可扫描真实QR码用认证器生成）
- **手动输入**: 显示真实密钥供手动输入到认证器应用

### 样式特性
- 响应式设计
- 步骤指示器
- 加载状态
- 错误处理

## 后续增强建议

1. **✅ 真实TOTP实现**：
   - ✅ 使用真实QR码图片
   - ✅ 提供真实TOTP密钥
   - ⚠️ 待实现：集成真实的TOTP库（如 `otplib`）进行时间同步验证

2. **安全增强**：
   - 密钥加密存储
   - 验证失败锁定
   - 备用恢复码

3. **用户体验**：
   - 支持多种认证器应用
   - 提供设置指导
   - 允许跳过TOTP（可选）

## 故障排除

### 常见问题
1. **密码修改失败**: 检查密码强度要求
2. **TOTP对话框不显示**: 检查密码修改是否成功
3. **验证码验证失败**: 当前接受任意6位数字，检查输入格式

### 调试信息
打开浏览器开发者工具查看控制台日志：
- 登录过程日志
- 密码修改日志  
- TOTP设置日志
